<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddressIQ - Dutch Property Intelligence</title>
    <!-- Bulma CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bulma@1/css/bulma.min.css" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <style>
        /* Custom colour scheme - professional teal/slate palette */
        :root {
            --primary: #0d9488;
            --primary-dark: #0f766e;
            --primary-light: #14b8a6;
            --secondary: #334155;
            --secondary-dark: #1e293b;
            --accent: #f59e0b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            --bg-card: rgba(255, 255, 255, 0.95);
            --bg-card-hover: rgba(255, 255, 255, 1);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-light: rgba(0, 0, 0, 0.08);
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .full-height-columns {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .full-height-columns .columns {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }

        /* Professional navbar styling */
        .navbar.is-primary {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .navbar-brand .navbar-item {
            font-weight: 700;
            font-size: 1.4rem;
            letter-spacing: -0.5px;
            color: white !important;
        }
        .navbar-brand .navbar-item:hover {
            background: transparent !important;
        }
        .logo-icon {
            width: 28px;
            height: 28px;
            margin-right: 8px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            color: var(--primary);
        }

        #map {
            width: 100%;
            height: 100%;
        }
        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .sidebar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }
        .sidebar-content {
            height: 100%;
            overflow-y: auto;
            padding: 1.25rem 1.75rem 2rem;
            pointer-events: auto;
            direction: rtl; /* Right-to-left to put scrollbar on left */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .sidebar-content > * {
            direction: ltr; /* Reset content back to left-to-right */
        }
        .sidebar-overlay,
        .sidebar-content {
            background: transparent;
        }
        .panel-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
        }
        .search-panel,
        .results-header-panel,
        .results-wrapper {
            pointer-events: auto;
        }
        /* Custom scrollbar styling */
        .sidebar-content::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        /* Search panel styling */
        .search-panel .box {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            border: 1px solid var(--border-light);
        }
        .search-panel .label {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
        }
        .search-panel .input {
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        .search-panel .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.15);
        }
        .search-panel .button.is-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .search-panel .button.is-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.35);
        }

        /* Results header styling */
        .results-header-panel .box {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            border: 1px solid var(--border-light);
        }
        .results-header-panel .title {
            color: var(--text-primary);
            font-weight: 700;
        }

        /* API results grid - larger cards */
        .api-results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Result card styling - more prominent */
        .result-card {
            margin: 0 !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            background: var(--bg-card) !important;
            border-radius: 12px !important;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-light) !important;
            padding: 1rem !important;
            transition: all 0.2s ease;
        }
        .result-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        /* Card header with status indicator */
        .result-card .card-header-title {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-dot.success { background: var(--success); }
        .status-dot.error { background: var(--danger); }
        .status-dot.warning { background: var(--warning); }

        /* Key metric display - large and prominent */
        .metric-display {
            margin: 0.75rem 0;
        }
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }
        .metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }
        .metric-secondary {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        .metric-secondary strong {
            color: var(--text-primary);
        }

        /* Status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-badge.good { background: rgba(16, 185, 129, 0.15); color: #059669; }
        .status-badge.moderate { background: rgba(245, 158, 11, 0.15); color: #d97706; }
        .status-badge.poor { background: rgba(239, 68, 68, 0.15); color: #dc2626; }

        /* Raw data toggle */
        .raw-data-toggle {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-light);
        }
        .raw-data-toggle summary {
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 500;
            transition: color 0.2s;
        }
        .raw-data-toggle summary:hover {
            color: var(--primary-dark);
        }
        .raw-data-toggle pre {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            font-size: 0.7rem;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        /* Section headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-light);
        }
        .section-header h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .section-icon {
            font-size: 1.25rem;
        }

        /* Summary notification */
        .summary-notification {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
            color: white !important;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }
        .summary-notification strong {
            color: white;
        }
        .summary-stats {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.5rem;
        }
        .summary-stat {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.9rem;
        }
        .result-card pre {
            word-break: break-all;
            white-space: pre-wrap;
        }
        .results-wrapper {
            margin-top: 0;
        }
        .desktop-results {
            min-height: 0;
        }
        body:not(.has-results) .desktop-results {
            display: none;
        }
        #results-header:empty {
            display: none;
        }

        /* Hide mobile results on desktop */
        .mobile-results {
            display: none;
        }

        /* Mobile layout */
        @media screen and (max-width: 768px) {
            html, body {
                height: 100%;
                overflow: hidden;
            }
            .navbar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 40;
            }
            .full-height-columns {
                height: 100%;
            }
            .full-height-columns .columns {
                position: static;
            }
            #map-container {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                z-index: 1;
            }
            .sidebar-overlay {
                position: fixed;
                inset: 0;
                width: 100%;
                height: 100%;
                display: flex;
                pointer-events: none;
                padding: 0;
                z-index: 30;
            }
            .sidebar-content {
                direction: ltr;
                padding: 0;
                height: 100%;
                width: 100%;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                gap: 1rem;
                pointer-events: none;
            }
            .panel-grid {
                display: contents;
            }
            .search-panel {
                order: 1;
                pointer-events: auto;
                margin-left: 1rem;
                margin-right: 1rem;
            }
            body:not(.has-results) .search-panel {
                margin-top: auto;
                margin-bottom: 1.25rem;
            }
            body.has-results .search-panel {
                margin-top: calc(3.5rem + 1rem);
                margin-bottom: 0.5rem;
            }
            .desktop-results {
                display: none !important;
            }
            /* Mobile results - show below search form */
            .mobile-results {
                order: 4;
                margin: 0 1rem 2rem;
                pointer-events: auto;
                max-height: calc(100vh - 200px);
                overflow-y: auto;
            }
            body:not(.has-results) .mobile-results {
                display: none;
            }
            /* Mobile-specific grid - single column for better readability */
            .mobile-results .api-results-grid {
                grid-template-columns: 1fr !important;
            }
            .mobile-results .result-card {
                margin-bottom: 0.5rem !important;
            }
            #results-header {
                order: 3;
                margin: 0 1rem 1.25rem;
                pointer-events: auto;
            }
            body:not(.has-results) #results-header {
                display: none;
            }
            body.has-results #results-header {
                margin-top: auto;
            }
        }
    </style>
</head>
<body>
    <div class="full-height-columns">
        <nav class="navbar is-primary">
            <div class="navbar-brand">
                <a class="navbar-item" href="#">
                    <span class="logo-icon">IQ</span>
                    AddressIQ
                </a>
            </div>
            <div class="navbar-end">
                <div class="navbar-item">
                    <span class="tag is-light is-size-7" id="build-info">Loading...</span>
                </div>
            </div>
        </nav>
        <div class="columns is-gapless">
            <!-- Map (full background) -->
            <div class="column" id="map-container">
                <div id="map"></div>
            </div>
            <!-- Floating Sidebar -->
            <div class="sidebar-overlay">
                <div class="sidebar-content">
                    <div class="panel-grid">
                        <div class="search-panel">
                            <div class="box">
                                <form
                                    id="search-form"
                                    hx-target="#results-container"
                                    hx-swap="innerHTML"
                                >
                                    <div class="field">
                                        <label class="label" for="postcode">Postcode</label>
                                        <div class="control">
                                            <input class="input" type="text" name="postcode" id="postcode" required />
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label" for="houseNumber">House Number</label>
                                        <div class="control">
                                            <input class="input" type="text" name="houseNumber" id="houseNumber" required />
                                        </div>
                                    </div>
                                    <div class="field">
                                        <div class="control">
                                            <button type="submit" class="button is-primary is-fullwidth" hx-disabled-elt="this">Search</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div id="results-header" class="results-header-panel"></div>
                    </div>
                    <div class="results-wrapper desktop-results">
                        <div id="results-desktop"></div>
                    </div>
                    <div class="results-wrapper mobile-results">
                        <div id="results-mobile"></div>
                    </div>
                    <div id="results-container" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
    let map;
    let currentResponse = null;
    let enabledAPIs = new Set(); // Track which APIs are enabled
    let apiHost = '';

        // Fetch build info from API
        async function fetchBuildInfo() {
            const buildInfoEl = document.getElementById('build-info');
            if (!buildInfoEl) {
                return;
            }
            try {
                const response = await fetch(apiHost + '/build-info');
                const data = await response.json();

                const repoUrl = 'https://github.com/iman-hussain/AddressIQ/commit/';
                const buildLine = (label, info) => {
                    if (!info || !info.commit || info.commit === 'unknown') {
                        return `${label}: (unknown)`;
                    }
                    const shortCommit = info.commit.length > 7 ? info.commit.substring(0, 7) : info.commit;
                    return `${label}: (<a href="${repoUrl}${info.commit}" target="_blank" rel="noopener noreferrer">${shortCommit}</a>)`;
                };

                const backendDate = data?.backend?.date ? new Date(data.backend.date) : null;
                const frontendDate = data?.frontend?.date ? new Date(data.frontend.date) : null;
                const mostRecentDate = [backendDate, frontendDate]
                    .filter(d => d instanceof Date && !isNaN(d.getTime()))
                    .sort((a, b) => b - a)[0];

                const formattedDate = mostRecentDate
                    ? mostRecentDate.toLocaleString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    })
                    : 'unknown';

                buildInfoEl.innerHTML = `${buildLine('Frontend Build', data.frontend)} ${buildLine('Backend Build', data.backend)} | ${formattedDate}`;
            } catch (error) {
                console.warn('Failed to fetch build info:', error);
                buildInfoEl.textContent = 'Build info unavailable';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Define apiHost based on hostname
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                apiHost = 'http://localhost:8080';
            } else {
                apiHost = 'https://api.addressiq.imanhussain.com';
            }

            // Populate build info dynamically from API
            fetchBuildInfo();

            map = new maplibregl.Map({
                container: 'map',
                style: 'https://demotiles.maplibre.org/style.json',
                center: [5.3878, 52.1561], // Center on Netherlands
                zoom: 7,
                minZoom: 6,
                maxZoom: 18,
                maxBounds: [
                    [2.5, 50.5],   // Southwest corner (just into the sea, below Belgium)
                    [8.5, 54.2]    // Northeast corner (just into Germany)
                ]
            });
            window.map = map;

            const applyMapPadding = () => {
                if (!map) return;
                if (window.innerWidth > 1024) {
                    map.setPadding({ left: window.innerWidth * 0.35, right: 40, top: 20, bottom: 40 });
                } else if (window.innerWidth > 768) {
                    map.setPadding({ left: window.innerWidth * 0.25, right: 20, top: 20, bottom: 40 });
                } else {
                    map.setPadding({ left: 0, right: 0, top: 0, bottom: 0 });
                }
            };
            applyMapPadding();
            window.addEventListener('resize', applyMapPadding);

            // Set hx-post on the form
            const searchForm = document.getElementById('search-form');
            searchForm.setAttribute('hx-post', apiHost + '/search');

            // Process with HTMX
            htmx.process(searchForm);

            // Load API preferences from localStorage
            const savedAPIs = localStorage.getItem('enabledAPIs');
            if (savedAPIs) {
                enabledAPIs = new Set(JSON.parse(savedAPIs));
            } else {
                // Default: all enabled
                enabledAPIs = new Set([
                    'BAG Address', 'Kadaster Object Info', 'Altum WOZ', 'Matrixian Property Value+',
                    'Altum Transactions', 'KNMI Weather', 'KNMI Solar', 'Luchtmeetnet Air Quality',
                    'Noise Pollution', 'CBS Population', 'CBS Square Statistics', 'WUR Soil Physicals',
                    'SkyGeo Subsidence', 'Soil Quality', 'BRO Soil Map', 'Altum Energy & Climate',
                    'Altum Sustainability', 'NDW Traffic', 'openOV Public Transport', 'Parking Availability',
                    'Flood Risk', 'Digital Delta Water Quality', 'CBS Safety Experience', 'Schiphol Flight Noise',
                    'Green Spaces', 'Education Facilities', 'Building Permits', 'Facilities & Amenities',
                    'AHN Height Model', 'Monument Status', 'PDOK Platform', 'Stratopo Environment', 'Land Use & Zoning'
                ]);
            }
        });

        document.body.addEventListener('htmx:beforeRequest', function (event) {
            const trigger = event.target;
            if (trigger && trigger.tagName === 'FORM' && trigger.getAttribute('hx-target') === '#results-container') {
                document.body.classList.remove('has-results');
                document.getElementById('results-header').innerHTML = '';
                const isMobile = window.innerWidth <= 768;
                const targetContainer = isMobile ? document.getElementById('results-mobile') : document.getElementById('results-desktop');
                if (targetContainer) targetContainer.innerHTML = '';
            }
        });

        // Update the map with new GeoJSON and zoom/circle location
        function updateMap(geojsonString) {
            if (!map) return;
            let geojson;
            try {
                geojson = JSON.parse(geojsonString);
            } catch (e) {
                console.error('Invalid GeoJSON:', e);
                return;
            }

            // Remove old sources/layers if they exist
            if (map.getLayer('parcel-layer')) map.removeLayer('parcel-layer');
            if (map.getSource('parcel-source')) map.removeSource('parcel-source');
            if (map.getLayer('location-circle')) map.removeLayer('location-circle');
            if (map.getSource('location-point')) map.removeSource('location-point');

            // Add parcel polygon if present
            if (geojson.type === 'Polygon' || geojson.type === 'FeatureCollection') {
                map.addSource('parcel-source', {
                    type: 'geojson',
                    data: geojson
                });
                map.addLayer({
                    id: 'parcel-layer',
                    type: 'fill',
                    source: 'parcel-source',
                    paint: {
                        'fill-color': '#2563eb', // blue
                        'fill-opacity': 0.5,
                        'fill-outline-color': '#000'
                    }
                });
            }

            // If we have a point, zoom and circle it
            let point = null;
            if (geojson.type === 'Point' && Array.isArray(geojson.coordinates)) {
                point = geojson.coordinates;
            } else if (geojson.type === 'Feature' && geojson.geometry && geojson.geometry.type === 'Point') {
                point = geojson.geometry.coordinates;
            } else if (geojson.type === 'FeatureCollection') {
                for (const feat of geojson.features) {
                    if (feat.geometry && feat.geometry.type === 'Point') {
                        point = feat.geometry.coordinates;
                        break;
                    }
                }
            }

            if (point) {
                map.flyTo({ center: point, zoom: 17 });
                map.addSource('location-point', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: { type: 'Point', coordinates: point }
                    }
                });
                map.addLayer({
                    id: 'location-circle',
                    type: 'circle',
                    source: 'location-point',
                    paint: {
                        'circle-radius': 18,
                        'circle-color': '#e63946',
                        'circle-opacity': 0.7,
                        'circle-stroke-width': 3,
                        'circle-stroke-color': '#fff'
                    }
                });
            } else if (geojson.type === 'Polygon' && Array.isArray(geojson.coordinates)) {
                // Fit map to bounds for polygon
                const coords = geojson.coordinates.flat(2);
                let minLng = coords[0][0], minLat = coords[0][1], maxLng = coords[0][0], maxLat = coords[0][1];
                coords.forEach(([lng, lat]) => {
                    if (lng < minLng) minLng = lng;
                    if (lng > maxLng) maxLng = lng;
                    if (lat < minLat) minLat = lat;
                    if (lat > maxLat) maxLat = lat;
                });
                map.fitBounds([[minLng, minLat], [maxLng, maxLat]], {padding: 40});
            }
        }

        // Listen for HTMX swaps in #results-container
        document.body.addEventListener('htmx:afterSwap', function(event) {
            const elt = event.detail.elt;

            if (elt && elt.id === 'results-container') {
                const container = elt;
                console.log('afterSwap container html', container.innerHTML.substring(0, 200));

                // Find header, results, and data elements directly in container
                const headerContent = container.querySelector('[data-target="header"]');
                console.log('headerContent found?', !!headerContent);
                const resultsContent = container.querySelector('[data-target="results"]');
                const dataHolder = container.querySelector('[data-geojson]');

                if (headerContent) {
                    document.getElementById('results-header').innerHTML = headerContent.innerHTML;
                }

                if (resultsContent) {
                    // Only populate the appropriate container based on screen size
                    const isMobile = window.innerWidth <= 768;
                    if (isMobile) {
                        document.getElementById('results-mobile').innerHTML = resultsContent.innerHTML;
                    } else {
                        document.getElementById('results-desktop').innerHTML = resultsContent.innerHTML;
                    }
                }

                if (dataHolder) {
                    const geojsonStr = dataHolder.getAttribute('data-geojson');
                    if (geojsonStr) {
                        updateMap(geojsonStr);
                    }

                    // Extract and store response data
                    const responseStr = dataHolder.getAttribute('data-response');
                    if (responseStr) {
                        currentResponse = JSON.parse(responseStr);
                        renderApiResults();
                    }
                }
            }
        });

        function formatApiData(apiName, data) {
            if (!data) return '';

            switch (apiName) {
                case 'KNMI Weather':
                    return `<div class="metric-display">
                        <div class="metric-value">${data.temperature || 0}¬∞C</div>
                        <div class="metric-label">Current Temperature</div>
                        <div class="metric-secondary">
                            üí® <strong>${data.windSpeed || 0}</strong> km/h &nbsp;|&nbsp;
                            üíß <strong>${data.humidity || 0}</strong>% &nbsp;|&nbsp;
                            üåßÔ∏è <strong>${data.precipitation || 0}</strong> mm
                        </div>
                    </div>`;

                case 'KNMI Solar':
                    return `<div class="metric-display">
                        <div class="metric-value">${(data.solarRadiation || 0).toFixed(0)} <span style="font-size: 1rem; font-weight: 500;">W/m¬≤</span></div>
                        <div class="metric-label">Solar Radiation</div>
                        <div class="metric-secondary">
                            ‚òÄÔ∏è <strong>${(data.sunshineHours || 0).toFixed(1)}</strong>h sunshine &nbsp;|&nbsp;
                            üï∂Ô∏è UV Index: <strong>${(data.uvIndex || 0).toFixed(1)}</strong>
                        </div>
                    </div>`;

                case 'Luchtmeetnet Air Quality':
                    const aqi = data.aqi || 0;
                    const category = data.category || 'Unknown';
                    const aqiBadgeClass = category === 'Good' ? 'good' : category === 'Moderate' ? 'moderate' : 'poor';
                    return `<div class="metric-display">
                        <div class="metric-value">${aqi}</div>
                        <div class="metric-label">Air Quality Index</div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${aqiBadgeClass}">${category}</span>
                        </div>
                        ${data.measurements && data.measurements.length > 0 ?
                            `<div class="metric-secondary">${data.measurements.slice(0, 3).map(m => `${m.parameter}: <strong>${m.value}</strong>${m.unit}`).join(' &nbsp;|&nbsp; ')}</div>` : ''}
                    </div>`;

                case 'CBS Population':
                    const pop = data.population || 0;
                    const households = data.households || 0;
                    return `<div class="metric-display">
                        <div class="metric-value">${pop.toLocaleString()}</div>
                        <div class="metric-label">Residents in Area</div>
                        <div class="metric-secondary">
                            üè† <strong>${households.toLocaleString()}</strong> households &nbsp;|&nbsp;
                            üìä Density: <strong>${(data.populationDensity || 0).toLocaleString()}</strong>/km¬≤
                        </div>
                    </div>`;

                case 'CBS Square Statistics':
                    return `<div class="metric-display">
                        <div class="metric-value">${data.inhabitants || data.area || 0}</div>
                        <div class="metric-label">${data.inhabitants ? 'Inhabitants' : 'Area (km¬≤)'}</div>
                        <div class="metric-secondary">
                            üè¢ <strong>${data.addresses || data.buildingCount || 0}</strong> addresses
                        </div>
                    </div>`;

                case 'Green Spaces':
                    const totalArea = data.totalArea || 0;
                    return `<div class="metric-display">
                        <div class="metric-value">${totalArea.toLocaleString()} <span style="font-size: 1rem; font-weight: 500;">m¬≤</span></div>
                        <div class="metric-label">Green Space Nearby</div>
                        <div class="metric-secondary">
                            üå≥ <strong>${data.count || 0}</strong> areas within <strong>${data.radius || 500}</strong>m
                        </div>
                    </div>`;

                case 'Education Facilities':
                    return `<div class="metric-display">
                        <div class="metric-value">${data.totalSchools || 0}</div>
                        <div class="metric-label">Schools Nearby</div>
                        <div class="metric-secondary">
                            üë®‚Äçüéì <strong>${(data.totalStudents || 0).toLocaleString()}</strong> students total
                        </div>
                    </div>`;

                case 'Facilities & Amenities':
                    const facilities = data.facilities || [];
                    const topCategories = [...new Set(facilities.map(f => f.category))].slice(0, 3);
                    return `<div class="metric-display">
                        <div class="metric-value">${data.totalFacilities || facilities.length || 0}</div>
                        <div class="metric-label">Amenities Nearby</div>
                        ${topCategories.length > 0 ? `<div class="metric-secondary">
                            ${topCategories.map(c => `<span class="status-badge good" style="margin-right: 4px; margin-top: 4px;">${c}</span>`).join('')}
                        </div>` : ''}
                    </div>`;

                case 'openOV Public Transport':
                    const stops = data.stops || [];
                    return `<div class="metric-display">
                        <div class="metric-value">${stops.length || data.count || 0}</div>
                        <div class="metric-label">PT Stops Nearby</div>
                        ${stops.length > 0 ? `<div class="metric-secondary">
                            ${stops.slice(0, 2).map(s => `üöè ${s.name || s.stopName || 'Stop'}`).join(' &nbsp;|&nbsp; ')}
                        </div>` : ''}
                    </div>`;

                case 'AHN Height Model':
                    return `<div class="metric-display">
                        <div class="metric-value">${(data.elevation || 0).toFixed(1)} <span style="font-size: 1rem; font-weight: 500;">m</span></div>
                        <div class="metric-label">Elevation (NAP)</div>
                        <div class="metric-secondary">
                            üìç Above sea level reference
                        </div>
                    </div>`;

                case 'Flood Risk':
                    const riskLevel = data.riskLevel || 'Unknown';
                    const floodBadgeClass = riskLevel === 'Low' ? 'good' : riskLevel === 'Medium' ? 'moderate' : 'poor';
                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${floodBadgeClass}" style="font-size: 0.9rem; padding: 6px 14px;">${riskLevel} Risk</span>
                        </div>
                        <div class="metric-label">Flood Risk Assessment</div>
                        ${data.zoneName ? `<div class="metric-secondary">Zone: <strong>${data.zoneName}</strong></div>` : ''}
                    </div>`;

                case 'NDW Traffic':
                    return `<div class="metric-display">
                        <div class="metric-value">${data.incidentCount || 0}</div>
                        <div class="metric-label">Traffic Incidents</div>
                        <div class="metric-secondary">
                            üöó Avg speed: <strong>${data.averageSpeed || 'N/A'}</strong> km/h
                        </div>
                    </div>`;

                case 'WUR Soil Physicals':
                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.25rem;">${data.soilType || 'Unknown'}</div>
                        <div class="metric-label">Soil Type</div>
                        <div class="metric-secondary">
                            pH: <strong>${data.ph || 'N/A'}</strong> &nbsp;|&nbsp;
                            Organic: <strong>${data.organicMatter || 'N/A'}</strong>%
                        </div>
                    </div>`;

                case 'BRO Soil Map':
                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.1rem;">${data.soilType || data.description || 'Data available'}</div>
                        <div class="metric-label">Soil Classification</div>
                    </div>`;

                case 'SkyGeo Subsidence':
                    const subsidence = data.subsidenceRate || 0;
                    const subsidenceClass = subsidence > 5 ? 'poor' : subsidence > 2 ? 'moderate' : 'good';
                    return `<div class="metric-display">
                        <div class="metric-value">${subsidence} <span style="font-size: 1rem; font-weight: 500;">mm/yr</span></div>
                        <div class="metric-label">Subsidence Rate</div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${subsidenceClass}">${subsidence > 5 ? 'High' : subsidence > 2 ? 'Medium' : 'Low'} Risk</span>
                        </div>
                    </div>`;

                case 'Monument Status':
                    const hasStatus = data.status && data.status !== 'Not protected';
                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${hasStatus ? 'moderate' : 'good'}">${data.status || 'Not Protected'}</span>
                        </div>
                        <div class="metric-label">Heritage Status</div>
                        ${data.description ? `<div class="metric-secondary">${data.description}</div>` : ''}
                    </div>`;

                case 'BAG Address':
                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1rem; font-weight: 600;">${data.address || 'Address verified'}</div>
                        <div class="metric-label">Official BAG Registration</div>
                        ${data.coordinates ? `<div class="metric-secondary">üìç ${data.coordinates[1]?.toFixed(5)}, ${data.coordinates[0]?.toFixed(5)}</div>` : ''}
                    </div>`;

                case 'PDOK Platform':
                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1rem;">${data.zoningInfo || 'Data Available'}</div>
                        <div class="metric-label">Platform Data</div>
                        ${data.restrictions && data.restrictions.length > 0 ?
                            `<div class="metric-secondary">‚ö†Ô∏è <strong>${data.restrictions.length}</strong> restrictions noted</div>` : ''}
                    </div>`;

                case 'Land Use & Zoning':
                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.1rem;">${data.landUseType || 'Unknown'}</div>
                        <div class="metric-label">Land Use Classification</div>
                        ${data.zoningCode ? `<div class="metric-secondary">Zone Code: <strong>${data.zoningCode}</strong></div>` : ''}
                    </div>`;

                // Default fallback for other APIs
                default:
                    if (typeof data === 'object' && Object.keys(data).length > 0) {
                        const firstKey = Object.keys(data)[0];
                        const firstValue = data[firstKey];
                        if (typeof firstValue === 'number' || typeof firstValue === 'string') {
                            return `<div class="metric-display">
                                <div class="metric-value" style="font-size: 1.25rem;">${typeof firstValue === 'number' ? firstValue.toLocaleString() : firstValue}</div>
                                <div class="metric-label">${firstKey.replace(/([A-Z])/g, ' $1').trim()}</div>
                            </div>`;
                        }
                    }
                    return `<div class="metric-display">
                        <div class="metric-label" style="color: var(--success);">‚úì Data retrieved successfully</div>
                    </div>`;
            }
        }

        function renderApiResults() {
            const isMobile = window.innerWidth <= 768;
            const targetContainer = isMobile ? document.getElementById('results-mobile') : document.getElementById('results-desktop');

            if (!targetContainer) {
                return;
            }

            if (!currentResponse || !currentResponse.apiResults) {
                targetContainer.innerHTML = '';
                document.body.classList.remove('has-results');
                return;
            }

            const grouped = currentResponse.apiResults;
            const allResults = [...grouped.free, ...grouped.freemium, ...grouped.premium];
            const filtered = allResults.filter(result => enabledAPIs.has(result.name));

            const successCount = filtered.filter(r => r.status === 'success').length;
            const errorCount = filtered.filter(r => r.status === 'error').length;
            const notConfiguredCount = filtered.filter(r => r.status === 'not_configured').length;

            let html = '<div class="summary-notification">';
            html += `<strong>Property Intelligence Report</strong>`;
            html += `<div class="summary-stats">`;
            html += `<span class="summary-stat">‚úì ${successCount} successful</span>`;
            html += `<span class="summary-stat">‚úó ${errorCount} errors</span>`;
            html += `<span class="summary-stat">‚ö† ${notConfiguredCount} not configured</span>`;
            html += `</div></div>`;

            // Helper function to render a section
            const renderSection = (title, icon, results) => {
                if (results.length === 0) return '';
                const sectionResults = results.filter(result => enabledAPIs.has(result.name));
                if (sectionResults.length === 0) return '';

                let sectionHtml = `<div class="mb-5">
                    <div class="section-header">
                        <span class="section-icon">${icon}</span>
                        <h4>${title}</h4>
                    </div>
                    <div class="api-results-grid">`;

                sectionResults.forEach(result => {
                    const statusClass = result.status === 'success' ? 'success' : result.status === 'error' ? 'error' : 'warning';
                    const errorMessage = result.error ? `<p class="metric-secondary" style="color: var(--danger);">${result.error}</p>` : '';
                    const formattedData = result.status === 'success' ? formatApiData(result.name, result.data) : '';
                    const dataBlock = result.data
                        ? `<details class="raw-data-toggle">
                                <summary>View Raw Data</summary>
                                <pre>${JSON.stringify(result.data, null, 2)}</pre>
                            </details>`
                        : '';

                    sectionHtml += `
                        <div class="result-card">
                            <div class="card-header-title">
                                <span class="status-dot ${statusClass}"></span>
                                ${result.name}
                            </div>
                            ${formattedData}
                            ${errorMessage}
                            ${dataBlock}
                        </div>
                    `;
                });

                sectionHtml += '</div></div>';
                return sectionHtml;
            };

            html += renderSection('Free APIs', 'üåê', grouped.free);
            html += renderSection('Freemium APIs', 'üîë', grouped.freemium);
            html += renderSection('Premium APIs', 'üí∞', grouped.premium);

            targetContainer.innerHTML = html;
            if (filtered.length > 0) {
                document.body.classList.add('has-results');
            } else {
                document.body.classList.remove('has-results');
            }
        }

        // Export data as CSV
        function exportCSV() {
            if (!currentResponse) {
                alert('No results to export');
                return;
            }

            const rows = [];
            rows.push(['Address', currentResponse.address]);
            rows.push(['Latitude', currentResponse.coordinates[1]]);
            rows.push(['Longitude', currentResponse.coordinates[0]]);
            rows.push([]);

            const grouped = currentResponse.apiResults;
            const allResults = [...grouped.free, ...grouped.freemium, ...grouped.premium];

            rows.push(['API Name', 'Category', 'Status', 'Data']);
            allResults
                .filter(r => enabledAPIs.has(r.name))
                .forEach(result => {
                    const dataStr = result.data ? JSON.stringify(result.data) : result.error || '';
                    rows.push([result.name, result.category, result.status, dataStr]);
                });

            const csvContent = rows.map(row =>
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `addressiq_${currentResponse.address.replace(/[^a-zA-Z0-9]/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Open settings modal
        function openSettings() {
            if (!currentResponse) {
                alert('Search for an address first');
                return;
            }

            const grouped = currentResponse.apiResults;
            const allAPIs = [...grouped.free, ...grouped.freemium, ...grouped.premium].map(r => r.name);

            let html = `
                <div class="modal is-active" id="settings-modal">
                    <div class="modal-background" onclick="closeSettings()"></div>
                    <div class="modal-card">
                        <header class="modal-card-head">
                            <p class="modal-card-title">API Settings</p>
                            <button class="delete" onclick="closeSettings()"></button>
                        </header>
                        <section class="modal-card-body">
                            <div class="buttons mb-3">
                                <button class="button is-success is-small" onclick="selectAllAPIs()">Select All</button>
                                <button class="button is-danger is-small" onclick="deselectAllAPIs()">Deselect All</button>
                            </div>
                            <div id="api-checkboxes">
            `;

            allAPIs.forEach(apiName => {
                const checked = enabledAPIs.has(apiName) ? 'checked' : '';
                html += `
                    <label class="checkbox is-block mb-2">
                        <input type="checkbox" value="${apiName}" ${checked} onchange="toggleAPI('${apiName}')">
                        ${apiName}
                    </label>
                `;
            });

            html += `
                            </div>
                        </section>
                        <footer class="modal-card-foot">
                            <button class="button is-success" onclick="saveSettings()">Save</button>
                            <button class="button" onclick="closeSettings()">Cancel</button>
                        </footer>
                    </div>
                </div>
            `;

            document.getElementById('modal-target').innerHTML = html;
        }

        function closeSettings() {
            document.getElementById('modal-target').innerHTML = '';
        }

        function toggleAPI(apiName) {
            if (enabledAPIs.has(apiName)) {
                enabledAPIs.delete(apiName);
            } else {
                enabledAPIs.add(apiName);
            }
            renderApiResults();
        }

        function selectAllAPIs() {
            if (!currentResponse) return;
            const grouped = currentResponse.apiResults;
            const allAPIs = [...grouped.free, ...grouped.freemium, ...grouped.premium];
            allAPIs.forEach(r => enabledAPIs.add(r.name));
            document.querySelectorAll('#api-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
            renderApiResults();
        }

        function deselectAllAPIs() {
            enabledAPIs.clear();
            document.querySelectorAll('#api-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
            renderApiResults();
        }

        function saveSettings() {
            localStorage.setItem('enabledAPIs', JSON.stringify([...enabledAPIs]));
            closeSettings();
            renderApiResults();
            alert('Settings saved! Enabled APIs: ' + enabledAPIs.size);
        }
    </script>
</body>
<div id="modal-target"></div>
</html>

