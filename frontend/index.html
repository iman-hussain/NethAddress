<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddressIQ</title>
    <!-- Bulma CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bulma@1/css/bulma.min.css" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .full-height-columns {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .full-height-columns .columns {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .sidebar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }
        .sidebar-content {
            height: 100%;
            overflow-y: auto;
            padding: 1.25rem 1.75rem 2rem;
            pointer-events: auto;
            direction: rtl; /* Right-to-left to put scrollbar on left */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .sidebar-content > * {
            direction: ltr; /* Reset content back to left-to-right */
        }
        .sidebar-overlay,
        .sidebar-content {
            background: transparent;
        }
        .panel-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
        }
        .search-panel,
        .results-header-panel,
        .results-wrapper {
            pointer-events: auto;
        }
        /* Custom scrollbar styling */
        .sidebar-content::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.5);
        }
        .api-results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .result-card {
            margin: 0 !important;
        }
        .results-wrapper {
            margin-top: 0;
        }
        .desktop-results {
            min-height: 0;
        }
        body:not(.has-results) .desktop-results {
            display: none;
        }
        #results-header:empty {
            display: none;
        }

        /* Mobile layout */
        @media screen and (max-width: 768px) {
            html, body {
                height: 100%;
                overflow: hidden;
            }
            .navbar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 40;
            }
            .full-height-columns {
                height: 100%;
            }
            .full-height-columns .columns {
                position: static;
            }
            #map-container {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                z-index: 1;
            }
            .sidebar-overlay {
                position: fixed;
                inset: 0;
                width: 100%;
                height: 100%;
                display: flex;
                pointer-events: none;
                padding: 0;
                z-index: 30;
            }
            .sidebar-content {
                direction: ltr;
                padding: 0;
                height: 100%;
                width: 100%;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                gap: 1rem;
                pointer-events: none;
            }
            .panel-grid {
                display: contents;
            }
            .search-panel {
                order: 1;
                pointer-events: auto;
                margin-left: 1rem;
                margin-right: 1rem;
            }
            body:not(.has-results) .search-panel {
                margin-top: auto;
                margin-bottom: 1.25rem;
            }
            body.has-results .search-panel {
                margin-top: calc(3.5rem + 1rem);
                margin-bottom: 0.5rem;
            }
            .desktop-results {
                display: none !important;
            }
            #results-header {
                order: 3;
                margin: 0 1rem 1.25rem;
                pointer-events: auto;
            }
            body:not(.has-results) #results-header {
                display: none;
            }
            body.has-results #results-header {
                margin-top: auto;
            }
        }
    </style>
</head>
<body>
    <div class="full-height-columns">
        <nav class="navbar is-primary">
            <div class="navbar-brand">
                <a class="navbar-item" href="#">
                    LocateNL
                </a>
            </div>
            <div class="navbar-end">
                <div class="navbar-item">
                    <span class="tag is-light is-size-7" id="build-info">Loading...</span>
                </div>
            </div>
        </nav>
        <div class="columns is-gapless">
            <!-- Map (full background) -->
            <div class="column" id="map-container">
                <div id="map"></div>
            </div>
            <!-- Floating Sidebar -->
            <div class="sidebar-overlay">
                <div class="sidebar-content">
                    <div class="panel-grid">
                        <div class="search-panel">
                            <div class="box">
                                <form
                                    id="search-form"
                                    hx-target="#results-container"
                                    hx-swap="innerHTML"
                                >
                                    <div class="field">
                                        <label class="label" for="postcode">Postcode</label>
                                        <div class="control">
                                            <input class="input" type="text" name="postcode" id="postcode" required />
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label" for="houseNumber">House Number</label>
                                        <div class="control">
                                            <input class="input" type="text" name="houseNumber" id="houseNumber" required />
                                        </div>
                                    </div>
                                    <div class="field">
                                        <div class="control">
                                            <button type="submit" class="button is-primary is-fullwidth" hx-disabled-elt="this">Search</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div id="results-header" class="results-header-panel"></div>
                    </div>
                    <div class="results-wrapper desktop-results">
                        <div id="results-desktop"></div>
                    </div>
                    <div id="results-container" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let map;
        let currentResponse = null;
        let enabledAPIs = new Set(); // Track which APIs are enabled

        // Fetch build info from API
        async function fetchBuildInfo() {
            try {
                const response = await fetch(apiHost + '/build-info');
                const data = await response.json();
                const buildInfoEl = document.getElementById('build-info');
                if (buildInfoEl && data.backend && data.frontend) {
                    const backendDate = new Date(data.backend.date);
                    const frontendDate = new Date(data.frontend.date);
                    const mostRecentDate = backendDate > frontendDate ? backendDate : frontendDate;
                    const formattedDate = mostRecentDate.toLocaleString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    
                    const repoUrl = 'https://github.com/iman-hussain/AddressIQ/commit/';
                    buildInfoEl.innerHTML = `Frontend Build: <a href="${repoUrl}${data.frontend.commit}" target="_blank">${data.frontend.commit.substring(0, 7)}</a> Backend Build: <a href="${repoUrl}${data.backend.commit}" target="_blank">${data.backend.commit.substring(0, 7)}</a> | ${formattedDate}`;
                }
            } catch (error) {
                console.warn('Failed to fetch build info:', error);
                const buildInfoEl = document.getElementById('build-info');
                if (buildInfoEl) {
                    buildInfoEl.textContent = 'Build info unavailable';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Populate build info dynamically from API
            fetchBuildInfo();

            map = new maplibregl.Map({
                container: 'map',
                style: 'https://demotiles.maplibre.org/style.json',
                center: [5.3878, 52.1561], // Center on Netherlands
                zoom: 7,
                minZoom: 6,
                maxZoom: 18,
                maxBounds: [
                    [2.5, 50.5],   // Southwest corner (just into the sea, below Belgium)
                    [8.5, 54.2]    // Northeast corner (just into Germany)
                ]
            });
            window.map = map;

            const applyMapPadding = () => {
                if (!map) return;
                if (window.innerWidth > 1024) {
                    map.setPadding({ left: window.innerWidth * 0.35, right: 40, top: 20, bottom: 40 });
                } else if (window.innerWidth > 768) {
                    map.setPadding({ left: window.innerWidth * 0.25, right: 20, top: 20, bottom: 40 });
                } else {
                    map.setPadding({ left: 0, right: 0, top: 0, bottom: 0 });
                }
            };
            applyMapPadding();
            window.addEventListener('resize', applyMapPadding);

            // Define apiHost based on hostname
            let apiHost;
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                apiHost = 'http://localhost:8080';
            } else {
                apiHost = 'https://api.addressiq.imanhussain.com';
            }

            // Set hx-post on the form
            const searchForm = document.getElementById('search-form');
            searchForm.setAttribute('hx-post', apiHost + '/search');

            // Process with HTMX
            htmx.process(searchForm);

            // Load API preferences from localStorage
            const savedAPIs = localStorage.getItem('enabledAPIs');
            if (savedAPIs) {
                enabledAPIs = new Set(JSON.parse(savedAPIs));
            } else {
                // Default: all enabled
                enabledAPIs = new Set([
                    'BAG Address', 'Kadaster Object Info', 'Altum WOZ', 'Matrixian Property Value+',
                    'Altum Transactions', 'KNMI Weather', 'KNMI Solar', 'Luchtmeetnet Air Quality',
                    'Noise Pollution', 'CBS Population', 'CBS Square Statistics', 'WUR Soil Physicals',
                    'SkyGeo Subsidence', 'Soil Quality', 'BRO Soil Map', 'Altum Energy & Climate',
                    'Altum Sustainability', 'NDW Traffic', 'openOV Public Transport', 'Parking Availability',
                    'Flood Risk', 'Digital Delta Water Quality', 'CBS Safety Experience', 'Schiphol Flight Noise',
                    'Green Spaces', 'Education Facilities', 'Building Permits', 'Facilities & Amenities',
                    'AHN Height Model', 'Monument Status', 'PDOK Platform', 'Stratopo Environment', 'Land Use & Zoning'
                ]);
            }
        });

        document.body.addEventListener('htmx:beforeRequest', function (event) {
            const trigger = event.target;
            if (trigger && trigger.tagName === 'FORM' && trigger.getAttribute('hx-target') === '#results-container') {
                document.body.classList.remove('has-results');
                document.getElementById('results-header').innerHTML = '';
                const desktopResults = document.getElementById('results-desktop');
                if (desktopResults) desktopResults.innerHTML = '';
            }
        });

        // Update the map with new GeoJSON and zoom/circle location
        function updateMap(geojsonString) {
            if (!map) return;
            let geojson;
            try {
                geojson = JSON.parse(geojsonString);
            } catch (e) {
                console.error('Invalid GeoJSON:', e);
                return;
            }

            // Remove old sources/layers if they exist
            if (map.getLayer('parcel-layer')) map.removeLayer('parcel-layer');
            if (map.getSource('parcel-source')) map.removeSource('parcel-source');
            if (map.getLayer('location-circle')) map.removeLayer('location-circle');
            if (map.getSource('location-point')) map.removeSource('location-point');

            // Add parcel polygon if present
            if (geojson.type === 'Polygon' || geojson.type === 'FeatureCollection') {
                map.addSource('parcel-source', {
                    type: 'geojson',
                    data: geojson
                });
                map.addLayer({
                    id: 'parcel-layer',
                    type: 'fill',
                    source: 'parcel-source',
                    paint: {
                        'fill-color': '#2563eb', // blue
                        'fill-opacity': 0.5,
                        'fill-outline-color': '#000'
                    }
                });
            }

            // If we have a point, zoom and circle it
            let point = null;
            if (geojson.type === 'Point' && Array.isArray(geojson.coordinates)) {
                point = geojson.coordinates;
            } else if (geojson.type === 'Feature' && geojson.geometry && geojson.geometry.type === 'Point') {
                point = geojson.geometry.coordinates;
            } else if (geojson.type === 'FeatureCollection') {
                for (const feat of geojson.features) {
                    if (feat.geometry && feat.geometry.type === 'Point') {
                        point = feat.geometry.coordinates;
                        break;
                    }
                }
            }

            if (point) {
                map.flyTo({ center: point, zoom: 17 });
                map.addSource('location-point', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: { type: 'Point', coordinates: point }
                    }
                });
                map.addLayer({
                    id: 'location-circle',
                    type: 'circle',
                    source: 'location-point',
                    paint: {
                        'circle-radius': 18,
                        'circle-color': '#e63946',
                        'circle-opacity': 0.7,
                        'circle-stroke-width': 3,
                        'circle-stroke-color': '#fff'
                    }
                });
            } else if (geojson.type === 'Polygon' && Array.isArray(geojson.coordinates)) {
                // Fit map to bounds for polygon
                const coords = geojson.coordinates.flat(2);
                let minLng = coords[0][0], minLat = coords[0][1], maxLng = coords[0][0], maxLat = coords[0][1];
                coords.forEach(([lng, lat]) => {
                    if (lng < minLng) minLng = lng;
                    if (lng > maxLng) maxLng = lng;
                    if (lat < minLat) minLat = lat;
                    if (lat > maxLat) maxLat = lat;
                });
                map.fitBounds([[minLng, minLat], [maxLng, maxLat]], {padding: 40});
            }
        }

        // Listen for HTMX swaps in #results-container
        document.body.addEventListener('htmx:afterSwap', function(event) {
            const elt = event.detail.elt;

            if (elt && elt.id === 'results-container') {
                const container = elt;
                console.log('afterSwap container html', container.innerHTML.substring(0, 200));

                // Find header, results, and data elements directly in container
                const headerContent = container.querySelector('[data-target="header"]');
                console.log('headerContent found?', !!headerContent);
                const resultsContent = container.querySelector('[data-target="results"]');
                const dataHolder = container.querySelector('[data-geojson]');

                if (headerContent) {
                    document.getElementById('results-header').innerHTML = headerContent.innerHTML;
                }

                if (resultsContent) {
                    document.getElementById('results-desktop').innerHTML = resultsContent.innerHTML;
                }

                if (dataHolder) {
                    const geojsonStr = dataHolder.getAttribute('data-geojson');
                    if (geojsonStr) {
                        updateMap(geojsonStr);
                    }

                    // Extract and store response data
                    const responseStr = dataHolder.getAttribute('data-response');
                    if (responseStr) {
                        currentResponse = JSON.parse(responseStr);
                    }
                }
            }
        });

        // Export data as CSV
        function exportCSV() {
            if (!currentResponse) {
                alert('No results to export');
                return;
            }

            const rows = [];
            rows.push(['Address', currentResponse.address]);
            rows.push(['Latitude', currentResponse.coordinates[1]]);
            rows.push(['Longitude', currentResponse.coordinates[0]]);
            rows.push([]);
            rows.push(['API Name', 'Status', 'Data']);

            currentResponse.apiResults
                .filter(r => enabledAPIs.has(r.name))
                .forEach(result => {
                    const dataStr = result.data ? JSON.stringify(result.data) : result.error || '';
                    rows.push([result.name, result.status, dataStr]);
                });

            const csvContent = rows.map(row =>
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `addressiq_${currentResponse.address.replace(/[^a-zA-Z0-9]/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Open settings modal
        function openSettings() {
            if (!currentResponse) {
                alert('Search for an address first');
                return;
            }

            const allAPIs = currentResponse.apiResults.map(r => r.name);

            let html = `
                <div class="modal is-active" id="settings-modal">
                    <div class="modal-background" onclick="closeSettings()"></div>
                    <div class="modal-card">
                        <header class="modal-card-head">
                            <p class="modal-card-title">API Settings</p>
                            <button class="delete" onclick="closeSettings()"></button>
                        </header>
                        <section class="modal-card-body">
                            <div class="buttons mb-3">
                                <button class="button is-success is-small" onclick="selectAllAPIs()">Select All</button>
                                <button class="button is-danger is-small" onclick="deselectAllAPIs()">Deselect All</button>
                            </div>
                            <div id="api-checkboxes">
            `;

            allAPIs.forEach(apiName => {
                const checked = enabledAPIs.has(apiName) ? 'checked' : '';
                html += `
                    <label class="checkbox is-block mb-2">
                        <input type="checkbox" value="${apiName}" ${checked} onchange="toggleAPI('${apiName}')">
                        ${apiName}
                    </label>
                `;
            });

            html += `
                            </div>
                        </section>
                        <footer class="modal-card-foot">
                            <button class="button is-success" onclick="saveSettings()">Save</button>
                            <button class="button" onclick="closeSettings()">Cancel</button>
                        </footer>
                    </div>
                </div>
            `;

            document.getElementById('modal-target').innerHTML = html;
        }

        function closeSettings() {
            document.getElementById('modal-target').innerHTML = '';
        }

        function toggleAPI(apiName) {
            if (enabledAPIs.has(apiName)) {
                enabledAPIs.delete(apiName);
            } else {
                enabledAPIs.add(apiName);
            }
        }

        function selectAllAPIs() {
            if (!currentResponse) return;
            currentResponse.apiResults.forEach(r => enabledAPIs.add(r.name));
            document.querySelectorAll('#api-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deselectAllAPIs() {
            enabledAPIs.clear();
            document.querySelectorAll('#api-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function saveSettings() {
            localStorage.setItem('enabledAPIs', JSON.stringify([...enabledAPIs]));
            closeSettings();
            alert('Settings saved! Enabled APIs: ' + enabledAPIs.size);
        }
    </script>
</body>
<div id="modal-target"></div>
</html>

