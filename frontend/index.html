<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddressIQ - Dutch Property Intelligence</title>
    <!-- Google Fonts - Inter for clean modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Bulma CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bulma@1/css/bulma.min.css" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <style>
        /*
         * AddressIQ Design System
         * Modern, high-contrast, readable colour scheme
         * Works great in day and night - no dark mode needed
         */
        :root {
            /* Primary brand - vibrant blue that's easy on eyes */
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: #3b82f6;

            /* Neutral greys - high contrast for readability */
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --bg-card-alt: #f1f5f9;
            --bg-dark: #0f172a;

            /* Text colours - strong contrast */
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --text-on-primary: #ffffff;

            /* Status colours - vibrant and clear */
            --success: #16a34a;
            --success-bg: #dcfce7;
            --warning: #ca8a04;
            --warning-bg: #fef9c3;
            --danger: #dc2626;
            --danger-bg: #fee2e2;
            --info: #0284c7;
            --info-bg: #e0f2fe;

            /* Borders and shadows */
            --border: #e2e8f0;
            --border-strong: #cbd5e1;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);

            /* Spacing */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        /* Base styles */
        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-page);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .full-height-columns {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .full-height-columns .columns {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }

        /* ========================================
           NAVBAR - Clean and prominent
           ======================================== */
        .navbar.is-primary {
            background: var(--bg-dark);
            box-shadow: var(--shadow-md);
            padding: 0.5rem 0;
        }
        .navbar-brand .navbar-item {
            font-weight: 800;
            font-size: 1.5rem;
            letter-spacing: -0.5px;
            color: white !important;
            gap: 0.5rem;
        }
        .navbar-brand .navbar-item:hover {
            background: transparent !important;
        }
        .logo-icon {
            font-size: 1.5rem;
        }
        .navbar-end .tag {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.8);
            font-size: 0.75rem;
        }

        /* ========================================
           MAP AND LAYOUT
           ======================================== */
        #map {
            width: 100%;
            height: 100%;
        }
        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .sidebar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 52%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }
        .sidebar-content {
            height: 100%;
            overflow-y: auto;
            padding: 1.5rem 2rem 2rem;
            pointer-events: auto;
            direction: rtl;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        .sidebar-content > * {
            direction: ltr;
        }
        .sidebar-overlay,
        .sidebar-content {
            background: transparent;
        }
        .panel-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1.25rem;
        }
        .search-panel,
        .results-header-panel,
        .results-wrapper {
            pointer-events: auto;
        }

        /* Custom scrollbar */
        .sidebar-content::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar-content::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-content::-webkit-scrollbar-thumb {
            background: var(--border-strong);
            border-radius: 4px;
        }
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ========================================
           SEARCH PANEL - Clean and prominent
           ======================================== */
        .search-panel .box {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            padding: 1.5rem;
        }
        .search-panel .label {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .search-panel .input {
            border-radius: var(--radius-sm);
            border: 2px solid var(--border);
            font-size: 1rem;
            padding: 0.75rem 1rem;
            height: auto;
            transition: all 0.2s ease;
        }
        .search-panel .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }
        .search-panel .input::placeholder {
            color: var(--text-muted);
        }
        .search-panel .button.is-primary {
            background: var(--primary);
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 1rem;
            padding: 0.75rem 1.5rem;
            height: auto;
            transition: all 0.2s ease;
        }
        .search-panel .button.is-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* ========================================
           RESULTS HEADER
           ======================================== */
        .results-header-panel .box {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            padding: 1.25rem 1.5rem;
        }
        .results-header-panel .title {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        .results-header-panel .is-size-6 {
            color: var(--text-secondary);
            font-size: 0.95rem !important;
        }

        /* ========================================
           API RESULTS GRID
           ======================================== */
        .api-results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        /* ========================================
           RESULT CARDS - Big, readable, modern
           ======================================== */
        .result-card {
            background: var(--bg-card) !important;
            border-radius: var(--radius-md) !important;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border) !important;
            padding: 1.25rem !important;
            transition: all 0.2s ease;
            margin: 0 !important;
        }
        .result-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--border-strong) !important;
        }

        /* Card header */
        .card-header-title {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        /* Status indicator dot */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-dot.success { background: var(--success); }
        .status-dot.error { background: var(--danger); }
        .status-dot.warning { background: var(--warning); }

        /* ========================================
           METRIC DISPLAY - Large and readable
           ======================================== */
        .metric-display {
            margin: 0.75rem 0 0.5rem;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1.1;
            letter-spacing: -0.5px;
        }
        .metric-value span {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .metric-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }
        .metric-secondary {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            line-height: 1.5;
        }
        .metric-secondary strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* ========================================
           STATUS BADGES - Clear and vibrant
           ======================================== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .status-badge.good {
            background: var(--success-bg);
            color: var(--success);
        }
        .status-badge.moderate {
            background: var(--warning-bg);
            color: var(--warning);
        }
        .status-badge.poor {
            background: var(--danger-bg);
            color: var(--danger);
        }

        /* ========================================
           RAW DATA TOGGLE
           ======================================== */
        .raw-data-toggle {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }
        .raw-data-toggle summary {
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 600;
            transition: color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }
        .raw-data-toggle summary:hover {
            color: var(--primary-hover);
        }
        .raw-data-toggle summary::before {
            content: 'üìÑ';
        }
        .raw-data-toggle pre {
            margin-top: 0.75rem;
            padding: 1rem;
            background: var(--bg-dark);
            color: #e2e8f0;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            line-height: 1.5;
        }

        /* ========================================
           SECTION HEADERS
           ======================================== */
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }
        .section-header h4 {
            margin: 0;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .section-icon {
            font-size: 1.5rem;
        }

        /* ========================================
           SUMMARY NOTIFICATION
           ======================================== */
        .summary-notification {
            background: var(--bg-dark) !important;
            color: white !important;
            border-radius: var(--radius-md);
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
        }
        .summary-notification strong {
            color: white;
            font-size: 1.1rem;
        }
        .summary-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
            margin-top: 0.75rem;
        }
        .summary-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
        }
        /* Misc */
        .result-card pre {
            word-break: break-all;
            white-space: pre-wrap;
        }
        .results-wrapper {
            margin-top: 0;
        }
        .desktop-results {
            min-height: 0;
        }
        body:not(.has-results) .desktop-results {
            display: none;
        }
        #results-header:empty {
            display: none;
        }
        .mobile-results {
            display: none;
        }

        /* ========================================
           MOBILE LAYOUT
           ======================================== */
        @media screen and (max-width: 768px) {
            html, body {
                height: 100%;
                overflow: hidden;
            }
            .navbar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 40;
            }
            .navbar-brand .navbar-item {
                font-size: 1.25rem;
            }
            .full-height-columns {
                height: 100%;
            }
            .full-height-columns .columns {
                position: static;
            }
            #map-container {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                z-index: 1;
            }
            .sidebar-overlay {
                position: fixed;
                inset: 0;
                width: 100%;
                height: 100%;
                display: flex;
                pointer-events: none;
                padding: 0;
                z-index: 30;
            }
            .sidebar-content {
                direction: ltr;
                padding: 0;
                height: 100%;
                width: 100%;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                gap: 1rem;
                pointer-events: none;
            }
            .panel-grid {
                display: contents;
            }
            .search-panel {
                order: 1;
                pointer-events: auto;
                margin-left: 1rem;
                margin-right: 1rem;
            }
            body:not(.has-results) .search-panel {
                margin-top: auto;
                margin-bottom: 1.25rem;
            }
            body.has-results .search-panel {
                margin-top: calc(3.5rem + 1rem);
                margin-bottom: 0.5rem;
            }
            .desktop-results {
                display: none !important;
            }
            /* Mobile results - show below search form */
            .mobile-results {
                order: 4;
                margin: 0 1rem 2rem;
                pointer-events: auto;
                max-height: calc(100vh - 200px);
                overflow-y: auto;
            }
            body:not(.has-results) .mobile-results {
                display: none;
            }
            /* Mobile-specific grid - single column for better readability */
            .mobile-results .api-results-grid {
                grid-template-columns: 1fr !important;
            }
            .mobile-results .result-card {
                margin-bottom: 0.5rem !important;
            }
            #results-header {
                order: 3;
                margin: 0 1rem 1.25rem;
                pointer-events: auto;
            }
            body:not(.has-results) #results-header {
                display: none;
            }
            body.has-results #results-header {
                margin-top: auto;
            }
        }
    </style>
</head>
<body>
    <div class="full-height-columns">
        <nav class="navbar is-primary">
            <div class="navbar-brand">
                <a class="navbar-item" href="#">
                    <span class="logo-icon">üè†</span>
                    AddressIQ
                </a>
            </div>
            <div class="navbar-end">
                <div class="navbar-item">
                    <span class="tag is-light is-size-7" id="build-info">Loading...</span>
                </div>
            </div>
        </nav>
        <div class="columns is-gapless">
            <!-- Map (full background) -->
            <div class="column" id="map-container">
                <div id="map"></div>
            </div>
            <!-- Floating Sidebar -->
            <div class="sidebar-overlay">
                <div class="sidebar-content">
                    <div class="panel-grid">
                        <div class="search-panel">
                            <div class="box">
                                <form
                                    id="search-form"
                                    hx-target="#results-container"
                                    hx-swap="innerHTML"
                                >
                                    <div class="field">
                                        <label class="label" for="postcode">Postcode</label>
                                        <div class="control">
                                            <input class="input" type="text" name="postcode" id="postcode" required />
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label" for="houseNumber">House Number</label>
                                        <div class="control">
                                            <input class="input" type="text" name="houseNumber" id="houseNumber" required />
                                        </div>
                                    </div>
                                    <div class="field">
                                        <div class="control">
                                            <button type="submit" class="button is-primary is-fullwidth" hx-disabled-elt="this">Search</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div id="results-header" class="results-header-panel"></div>
                    </div>
                    <div class="results-wrapper desktop-results">
                        <div id="results-desktop"></div>
                    </div>
                    <div class="results-wrapper mobile-results">
                        <div id="results-mobile"></div>
                    </div>
                    <div id="results-container" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
    let map;
    let currentResponse = null;
    let enabledAPIs = new Set(); // Track which APIs are enabled
    let apiHost = '';

        // Fetch build info from API
        async function fetchBuildInfo() {
            const buildInfoEl = document.getElementById('build-info');
            if (!buildInfoEl) {
                return;
            }
            try {
                const response = await fetch(apiHost + '/build-info');
                const data = await response.json();

                const repoUrl = 'https://github.com/iman-hussain/AddressIQ/commit/';
                const buildLine = (label, info) => {
                    if (!info || !info.commit || info.commit === 'unknown') {
                        return `${label}: (unknown)`;
                    }
                    const shortCommit = info.commit.length > 7 ? info.commit.substring(0, 7) : info.commit;
                    return `${label}: (<a href="${repoUrl}${info.commit}" target="_blank" rel="noopener noreferrer">${shortCommit}</a>)`;
                };

                const backendDate = data?.backend?.date ? new Date(data.backend.date) : null;
                const frontendDate = data?.frontend?.date ? new Date(data.frontend.date) : null;
                const mostRecentDate = [backendDate, frontendDate]
                    .filter(d => d instanceof Date && !isNaN(d.getTime()))
                    .sort((a, b) => b - a)[0];

                const formattedDate = mostRecentDate
                    ? mostRecentDate.toLocaleString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    })
                    : 'unknown';

                buildInfoEl.innerHTML = `${buildLine('Frontend Build', data.frontend)} ${buildLine('Backend Build', data.backend)} | ${formattedDate}`;
            } catch (error) {
                console.warn('Failed to fetch build info:', error);
                buildInfoEl.textContent = 'Build info unavailable';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Define apiHost based on hostname
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                apiHost = 'http://localhost:8080';
            } else {
                apiHost = 'https://api.addressiq.imanhussain.com';
            }

            // Populate build info dynamically from API
            fetchBuildInfo();

            map = new maplibregl.Map({
                container: 'map',
                style: 'https://demotiles.maplibre.org/style.json',
                center: [5.3878, 52.1561], // Center on Netherlands
                zoom: 7,
                minZoom: 6,
                maxZoom: 18,
                maxBounds: [
                    [2.5, 50.5],   // Southwest corner (just into the sea, below Belgium)
                    [8.5, 54.2]    // Northeast corner (just into Germany)
                ]
            });
            window.map = map;

            const applyMapPadding = () => {
                if (!map) return;
                if (window.innerWidth > 1024) {
                    map.setPadding({ left: window.innerWidth * 0.35, right: 40, top: 20, bottom: 40 });
                } else if (window.innerWidth > 768) {
                    map.setPadding({ left: window.innerWidth * 0.25, right: 20, top: 20, bottom: 40 });
                } else {
                    map.setPadding({ left: 0, right: 0, top: 0, bottom: 0 });
                }
            };
            applyMapPadding();
            window.addEventListener('resize', applyMapPadding);

            // Set hx-post on the form
            const searchForm = document.getElementById('search-form');
            searchForm.setAttribute('hx-post', apiHost + '/search');

            // Process with HTMX
            htmx.process(searchForm);

            // Load API preferences from localStorage
            const savedAPIs = localStorage.getItem('enabledAPIs');
            if (savedAPIs) {
                enabledAPIs = new Set(JSON.parse(savedAPIs));
            } else {
                // Default: all enabled
                enabledAPIs = new Set([
                    'BAG Address', 'Kadaster Object Info', 'Altum WOZ', 'Matrixian Property Value+',
                    'Altum Transactions', 'KNMI Weather', 'KNMI Solar', 'Luchtmeetnet Air Quality',
                    'Noise Pollution', 'CBS Population', 'CBS Square Statistics', 'WUR Soil Physicals',
                    'SkyGeo Subsidence', 'Soil Quality', 'BRO Soil Map', 'Altum Energy & Climate',
                    'Altum Sustainability', 'NDW Traffic', 'openOV Public Transport', 'Parking Availability',
                    'Flood Risk', 'Digital Delta Water Quality', 'CBS Safety Experience', 'Schiphol Flight Noise',
                    'Green Spaces', 'Education Facilities', 'Building Permits', 'Facilities & Amenities',
                    'AHN Height Model', 'Monument Status', 'PDOK Platform', 'Stratopo Environment', 'Land Use & Zoning'
                ]);
            }
        });

        document.body.addEventListener('htmx:beforeRequest', function (event) {
            const trigger = event.target;
            if (trigger && trigger.tagName === 'FORM' && trigger.getAttribute('hx-target') === '#results-container') {
                document.body.classList.remove('has-results');
                document.getElementById('results-header').innerHTML = '';
                const isMobile = window.innerWidth <= 768;
                const targetContainer = isMobile ? document.getElementById('results-mobile') : document.getElementById('results-desktop');
                if (targetContainer) targetContainer.innerHTML = '';
            }
        });

        // Update the map with new GeoJSON and zoom/circle location
        function updateMap(geojsonString) {
            if (!map) return;
            let geojson;
            try {
                geojson = JSON.parse(geojsonString);
            } catch (e) {
                console.error('Invalid GeoJSON:', e);
                return;
            }

            // Remove old sources/layers if they exist
            if (map.getLayer('parcel-layer')) map.removeLayer('parcel-layer');
            if (map.getSource('parcel-source')) map.removeSource('parcel-source');
            if (map.getLayer('location-circle')) map.removeLayer('location-circle');
            if (map.getSource('location-point')) map.removeSource('location-point');

            // Add parcel polygon if present
            if (geojson.type === 'Polygon' || geojson.type === 'FeatureCollection') {
                map.addSource('parcel-source', {
                    type: 'geojson',
                    data: geojson
                });
                map.addLayer({
                    id: 'parcel-layer',
                    type: 'fill',
                    source: 'parcel-source',
                    paint: {
                        'fill-color': '#2563eb', // blue
                        'fill-opacity': 0.5,
                        'fill-outline-color': '#000'
                    }
                });
            }

            // If we have a point, zoom and circle it
            let point = null;
            if (geojson.type === 'Point' && Array.isArray(geojson.coordinates)) {
                point = geojson.coordinates;
            } else if (geojson.type === 'Feature' && geojson.geometry && geojson.geometry.type === 'Point') {
                point = geojson.geometry.coordinates;
            } else if (geojson.type === 'FeatureCollection') {
                for (const feat of geojson.features) {
                    if (feat.geometry && feat.geometry.type === 'Point') {
                        point = feat.geometry.coordinates;
                        break;
                    }
                }
            }

            if (point) {
                map.flyTo({ center: point, zoom: 17 });
                map.addSource('location-point', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: { type: 'Point', coordinates: point }
                    }
                });
                map.addLayer({
                    id: 'location-circle',
                    type: 'circle',
                    source: 'location-point',
                    paint: {
                        'circle-radius': 18,
                        'circle-color': '#e63946',
                        'circle-opacity': 0.7,
                        'circle-stroke-width': 3,
                        'circle-stroke-color': '#fff'
                    }
                });
            } else if (geojson.type === 'Polygon' && Array.isArray(geojson.coordinates)) {
                // Fit map to bounds for polygon
                const coords = geojson.coordinates.flat(2);
                let minLng = coords[0][0], minLat = coords[0][1], maxLng = coords[0][0], maxLat = coords[0][1];
                coords.forEach(([lng, lat]) => {
                    if (lng < minLng) minLng = lng;
                    if (lng > maxLng) maxLng = lng;
                    if (lat < minLat) minLat = lat;
                    if (lat > maxLat) maxLat = lat;
                });
                map.fitBounds([[minLng, minLat], [maxLng, maxLat]], {padding: 40});
            }
        }

        // Listen for HTMX swaps in #results-container
        document.body.addEventListener('htmx:afterSwap', function(event) {
            const elt = event.detail.elt;

            if (elt && elt.id === 'results-container') {
                const container = elt;
                console.log('afterSwap container html', container.innerHTML.substring(0, 200));

                // Find header, results, and data elements directly in container
                const headerContent = container.querySelector('[data-target="header"]');
                console.log('headerContent found?', !!headerContent);
                const resultsContent = container.querySelector('[data-target="results"]');
                const dataHolder = container.querySelector('[data-geojson]');

                if (headerContent) {
                    document.getElementById('results-header').innerHTML = headerContent.innerHTML;
                }

                if (resultsContent) {
                    // Only populate the appropriate container based on screen size
                    const isMobile = window.innerWidth <= 768;
                    if (isMobile) {
                        document.getElementById('results-mobile').innerHTML = resultsContent.innerHTML;
                    } else {
                        document.getElementById('results-desktop').innerHTML = resultsContent.innerHTML;
                    }
                }

                if (dataHolder) {
                    const geojsonStr = dataHolder.getAttribute('data-geojson');
                    if (geojsonStr) {
                        updateMap(geojsonStr);
                    }

                    // Extract and store response data
                    const responseStr = dataHolder.getAttribute('data-response');
                    if (responseStr) {
                        currentResponse = JSON.parse(responseStr);
                        renderApiResults();
                    }
                }
            }
        });

        function formatApiData(apiName, data) {
            if (!data) return '';

            switch (apiName) {
                case 'KNMI Weather':
                    return `<div class="metric-display">
                        <div class="metric-value">${data.temperature || 0}¬∞C</div>
                        <div class="metric-label">Current Temperature</div>
                        <div class="metric-secondary">
                            üí® <strong>${data.windSpeed || 0}</strong> km/h &nbsp;|&nbsp;
                            üíß <strong>${data.humidity || 0}</strong>% &nbsp;|&nbsp;
                            üåßÔ∏è <strong>${data.precipitation || 0}</strong> mm
                        </div>
                    </div>`;

                case 'KNMI Solar':
                    return `<div class="metric-display">
                        <div class="metric-value">${(data.solarRadiation || 0).toFixed(0)} <span style="font-size: 1rem; font-weight: 500;">W/m¬≤</span></div>
                        <div class="metric-label">Solar Radiation</div>
                        <div class="metric-secondary">
                            ‚òÄÔ∏è <strong>${(data.sunshineHours || 0).toFixed(1)}</strong>h sunshine &nbsp;|&nbsp;
                            üï∂Ô∏è UV Index: <strong>${(data.uvIndex || 0).toFixed(1)}</strong>
                        </div>
                    </div>`;

                case 'Luchtmeetnet Air Quality':
                    const aqi = data.aqi || 0;
                    const category = data.category || 'Unknown';
                    const aqiBadgeClass = category === 'Good' ? 'good' : category === 'Moderate' ? 'moderate' : 'poor';
                    return `<div class="metric-display">
                        <div class="metric-value">${aqi}</div>
                        <div class="metric-label">Air Quality Index</div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${aqiBadgeClass}">${category}</span>
                        </div>
                        ${data.measurements && data.measurements.length > 0 ?
                            `<div class="metric-secondary">${data.measurements.slice(0, 3).map(m => `${m.parameter}: <strong>${m.value}</strong>${m.unit}`).join(' &nbsp;|&nbsp; ')}</div>` : ''}
                    </div>`;

                case 'CBS Population':
                    // Handle both field names: totalPopulation (from API) and population (legacy)
                    const pop = data.totalPopulation || data.population || 0;
                    const households = data.households || 0;
                    const avgHouseholdSize = data.averageHouseholdSize || 0;
                    const ageDist = data.ageDistribution || data.demographics || {};

                    let ageBreakdown = '';
                    if (Object.keys(ageDist).length > 0) {
                        const ageLabels = Object.keys(ageDist).slice(0, 3);
                        ageBreakdown = ageLabels.map(k => `${k}: <strong>${ageDist[k]}</strong>`).join(' &nbsp;|&nbsp; ');
                    }

                    return `<div class="metric-display">
                        <div class="metric-value">${pop.toLocaleString()}</div>
                        <div class="metric-label">Residents in Area</div>
                        <div class="metric-secondary">
                            üè† <strong>${households.toLocaleString()}</strong> households
                            ${avgHouseholdSize ? ` &nbsp;|&nbsp; üë• Avg size: <strong>${avgHouseholdSize}</strong>` : ''}
                        </div>
                        ${ageBreakdown ? `<div class="metric-secondary" style="margin-top: 0.25rem;">${ageBreakdown}</div>` : ''}
                    </div>`;

                case 'CBS Square Statistics':
                    // API returns: gridId, population, households, averageWOZ, averageIncome, housingDensity
                    const sqPop = data.population || 0;
                    const sqHouseholds = data.households || 0;
                    const sqDensity = data.housingDensity || 0;
                    const sqWOZ = data.averageWOZ || 0;

                    return `<div class="metric-display">
                        <div class="metric-value">${sqPop.toLocaleString()}</div>
                        <div class="metric-label">Population (Grid Area)</div>
                        <div class="metric-secondary">
                            üè† <strong>${sqHouseholds.toLocaleString()}</strong> households &nbsp;|&nbsp;
                            üìä Density: <strong>${sqDensity.toLocaleString()}</strong>/km¬≤
                        </div>
                        ${sqWOZ > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üí∞ Avg WOZ: <strong>‚Ç¨${sqWOZ.toLocaleString()}</strong>
                        </div>` : ''}
                    </div>`;

                case 'Green Spaces':
                    // API returns: totalGreenArea, greenPercentage, nearestPark, parkDistance, treeCanopyCover, greenSpaces[]
                    const greenSpacesArr = data.greenSpaces || [];
                    const totalGreenArea = data.totalGreenArea || 0;
                    const greenPct = data.greenPercentage || 0;
                    const treeCanopy = data.treeCanopyCover || 0;
                    const greenSpaceCount = greenSpacesArr.length;
                    const greenTypes = [...new Set(greenSpacesArr.map(s => s.type).filter(t => t))].slice(0, 3);

                    return `<div class="metric-display">
                        <div class="metric-value">${totalGreenArea.toLocaleString()} <span style="font-size: 1rem; font-weight: 500;">m¬≤</span></div>
                        <div class="metric-label">Green Space Nearby</div>
                        <div class="metric-secondary">
                            üå≥ <strong>${greenSpaceCount}</strong> areas &nbsp;|&nbsp;
                            üìä <strong>${(greenPct * 100).toFixed(1)}%</strong> green coverage
                        </div>
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üå≤ Tree canopy: <strong>${(treeCanopy * 100).toFixed(1)}%</strong>
                        </div>
                        ${greenTypes.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${greenTypes.map(t => `<span class="status-badge good" style="margin-right: 4px;">${t}</span>`).join('')}
                        </div>` : ''}
                    </div>`;

                case 'Education Facilities':
                    // API returns: nearestPrimarySchool, nearestSecondarySchool, allSchools[], averageQuality
                    const allSchools = data.allSchools || [];
                    const nearestPrimary = data.nearestPrimarySchool;
                    const nearestSecondary = data.nearestSecondarySchool;
                    const avgQuality = data.averageQuality || 0;
                    const schoolCount = allSchools.length;
                    const schoolTypeSet = [...new Set(allSchools.map(s => s.type).filter(t => t))];

                    return `<div class="metric-display">
                        <div class="metric-value">${schoolCount}</div>
                        <div class="metric-label">Schools Nearby</div>
                        ${nearestPrimary ? `<div class="metric-secondary">
                            üè´ Nearest: <strong>${nearestPrimary.name}</strong> (${Math.round(nearestPrimary.distance)}m)
                        </div>` : ''}
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            ‚≠ê Avg quality: <strong>${avgQuality}/10</strong>
                            ${schoolTypeSet.length > 0 ? ` &nbsp;|&nbsp; ${schoolTypeSet.map(t => `<span class="status-badge good" style="margin-right: 4px;">${t}</span>`).join('')}` : ''}
                        </div>
                    </div>`;

                case 'Facilities & Amenities':
                    // API returns: topFacilities[], amenitiesScore, categoryCounts{}
                    const topFacilities = data.topFacilities || [];
                    const amenitiesScore = data.amenitiesScore || 0;
                    const catCounts = data.categoryCounts || {};
                    const totalFacilities = Object.values(catCounts).reduce((a, b) => a + b, 0) || topFacilities.length;
                    const categoryNames = Object.keys(catCounts).slice(0, 4);
                    const nearestFacility = topFacilities[0];

                    return `<div class="metric-display">
                        <div class="metric-value">${totalFacilities}</div>
                        <div class="metric-label">Amenities Nearby</div>
                        <div class="metric-secondary">
                            ‚≠ê Score: <strong>${amenitiesScore.toFixed(1)}</strong>/100
                        </div>
                        ${categoryNames.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${categoryNames.map(c => `<span class="status-badge good" style="margin-right: 4px; margin-bottom: 4px;">${c} (${catCounts[c]})</span>`).join('')}
                        </div>` : ''}
                        ${nearestFacility ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç Nearest: <strong>${nearestFacility.name}</strong> (${Math.round(nearestFacility.distance)}m)
                        </div>` : ''}
                    </div>`;

                case 'openOV Public Transport':
                    // API returns: nearestStops[], connections[]
                    const nearestStops = data.nearestStops || [];
                    const stopCount = nearestStops.length;
                    const stopTypes = [...new Set(nearestStops.map(s => s.type).filter(t => t))];
                    const nearestStop = nearestStops[0];
                    const trainStops = nearestStops.filter(s => s.type === 'Train');
                    const busStops = nearestStops.filter(s => s.type === 'Bus');

                    return `<div class="metric-display">
                        <div class="metric-value">${stopCount}</div>
                        <div class="metric-label">PT Stops Nearby</div>
                        ${stopTypes.length > 0 ? `<div class="metric-secondary">
                            ${stopTypes.map(t => `<span class="status-badge good" style="margin-right: 4px;">üöè ${t} (${t === 'Train' ? trainStops.length : t === 'Bus' ? busStops.length : nearestStops.filter(s => s.type === t).length})</span>`).join('')}
                        </div>` : ''}
                        ${nearestStop ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç Nearest: <strong>${nearestStop.name}</strong> (${Math.round(nearestStop.distance)}m) - ${nearestStop.type}
                        </div>` : ''}
                    </div>`;

                case 'AHN Height Model':
                    const elevation = data.elevation || data.height || data.hoogte || 0;
                    return `<div class="metric-display">
                        <div class="metric-value">${(elevation).toFixed(1)} <span style="font-size: 1rem; font-weight: 500;">m</span></div>
                        <div class="metric-label">Elevation (NAP)</div>
                        <div class="metric-secondary">
                            üìç Above sea level reference
                        </div>
                    </div>`;

                case 'Noise Pollution':
                    // API returns: totalNoise, roadNoise, railNoise, industryNoise, aircraftNoise, noiseCategory, exceedsLimit
                    const totalNoise = data.totalNoise || 0;
                    const noiseCategory = data.noiseCategory || 'Unknown';
                    const noiseBadge = noiseCategory === 'Quiet' ? 'good' : noiseCategory === 'Moderate' ? 'moderate' : noiseCategory === 'Unknown' ? 'moderate' : 'poor';
                    const noiseSources = [];
                    if (data.roadNoise > 0) noiseSources.push(`üöó Road: ${data.roadNoise}dB`);
                    if (data.railNoise > 0) noiseSources.push(`üöÇ Rail: ${data.railNoise}dB`);
                    if (data.aircraftNoise > 0) noiseSources.push(`‚úàÔ∏è Air: ${data.aircraftNoise}dB`);
                    if (data.industryNoise > 0) noiseSources.push(`üè≠ Industry: ${data.industryNoise}dB`);

                    return `<div class="metric-display">
                        <div class="metric-value">${totalNoise} <span style="font-size: 1rem; font-weight: 500;">dB(A)</span></div>
                        <div class="metric-label">Total Noise Level</div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${noiseBadge}">${noiseCategory}</span>
                            ${data.exceedsLimit ? '<span class="status-badge poor" style="margin-left: 4px;">‚ö†Ô∏è Exceeds Limit</span>' : ''}
                        </div>
                        ${noiseSources.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">${noiseSources.join(' &nbsp;|&nbsp; ')}</div>` : ''}
                    </div>`;

                case 'Parking Availability':
                    // API returns: totalSpaces, availableSpaces, occupancyRate, parkingZones[], lastUpdated
                    const totalSpaces = data.totalSpaces || 0;
                    const availableSpaces = data.availableSpaces || 0;
                    const occupancyRate = data.occupancyRate || 0;
                    const parkingZones = data.parkingZones || [];
                    const parkingBadge = occupancyRate < 50 ? 'good' : occupancyRate < 80 ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value">${totalSpaces > 0 ? availableSpaces : '--'}</div>
                        <div class="metric-label">Available Parking Spaces</div>
                        ${totalSpaces > 0 ? `<div class="metric-secondary">
                            üÖøÔ∏è <strong>${totalSpaces}</strong> total &nbsp;|&nbsp;
                            <span class="status-badge ${parkingBadge}">${occupancyRate.toFixed(0)}% occupied</span>
                        </div>` : '<div class="metric-secondary">üÖøÔ∏è No parking data available for this area</div>'}
                        ${parkingZones.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç <strong>${parkingZones.length}</strong> parking zones nearby
                        </div>` : ''}
                    </div>`;

                case 'Building Permits':
                    // API returns: totalPermits, newConstruction, renovations, permits[], growthTrend
                    const totalPermits = data.totalPermits || 0;
                    const newConstruction = data.newConstruction || 0;
                    const renovations = data.renovations || 0;
                    const growthTrend = data.growthTrend || 'Unknown';
                    const permits = data.permits || [];
                    const trendBadge = growthTrend === 'Increasing' ? 'good' : growthTrend === 'Stable' ? 'moderate' : growthTrend === 'Unknown' ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value">${totalPermits}</div>
                        <div class="metric-label">Building Permits (2yr)</div>
                        <div class="metric-secondary">
                            üèóÔ∏è New: <strong>${newConstruction}</strong> &nbsp;|&nbsp;
                            üîß Renovations: <strong>${renovations}</strong>
                        </div>
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìà Trend: <span class="status-badge ${trendBadge}">${growthTrend}</span>
                        </div>
                    </div>`;

                case 'CBS StatLine':
                    // API returns: regionCode, regionName, population, averageIncome, employmentRate, educationLevel, housingStock, averageWOZ, year
                    const slRegionName = data.regionName || 'Unknown';
                    const slPopulation = data.population || 0;
                    const slAvgIncome = data.averageIncome || 0;
                    const slEmploymentRate = data.employmentRate || 0;
                    const slEducationLevel = data.educationLevel || 'Unknown';
                    const slAvgWOZ = data.averageWOZ || 0;

                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.5rem;">‚Ç¨${slAvgIncome > 0 ? slAvgIncome.toLocaleString() : '--'}</div>
                        <div class="metric-label">Avg Household Income</div>
                        <div class="metric-secondary">
                            üë• Population: <strong>${slPopulation.toLocaleString()}</strong>
                            ${slEmploymentRate > 0 ? ` &nbsp;|&nbsp; üíº Employment: <strong>${slEmploymentRate.toFixed(1)}%</strong>` : ''}
                        </div>
                        ${slAvgWOZ > 0 || slEducationLevel !== 'Unknown' ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${slAvgWOZ > 0 ? `üí∞ Avg WOZ: <strong>‚Ç¨${slAvgWOZ.toLocaleString()}</strong>` : ''}
                            ${slEducationLevel !== 'Unknown' ? ` &nbsp;|&nbsp; üéì Education: <strong>${slEducationLevel}</strong>` : ''}
                        </div>` : ''}
                    </div>`;

                case 'Altum Energy & Climate':
                    // API returns: energyLabel, climateRisk, efficiencyScore, annualEnergyCost, co2Emissions, heatLoss
                    const energyLabel = data.energyLabel || 'Unknown';
                    const climateRisk = data.climateRisk || 'Unknown';
                    const efficiencyScore = data.efficiencyScore || 0;
                    const annualEnergyCost = data.annualEnergyCost || 0;
                    const co2Emissions = data.co2Emissions || 0;
                    const labelClass = ['A++++', 'A+++', 'A++', 'A+', 'A', 'B'].includes(energyLabel) ? 'good' : ['C', 'D'].includes(energyLabel) ? 'moderate' : 'poor';
                    const riskClass = climateRisk === 'Low' ? 'good' : climateRisk === 'Medium' ? 'moderate' : climateRisk === 'Unknown' ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${labelClass}" style="font-size: 1.1rem; padding: 8px 16px;">‚ö° ${energyLabel}</span>
                        </div>
                        <div class="metric-label">Energy Label</div>
                        <div class="metric-secondary" style="margin-top: 0.5rem;">
                            üå°Ô∏è Climate Risk: <span class="status-badge ${riskClass}">${climateRisk}</span>
                        </div>
                        ${annualEnergyCost > 0 || co2Emissions > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${annualEnergyCost > 0 ? `üí∂ ‚Ç¨${annualEnergyCost.toLocaleString()}/yr` : ''}
                            ${co2Emissions > 0 ? ` &nbsp;|&nbsp; üåç ${co2Emissions.toLocaleString()} kg CO‚ÇÇ/yr` : ''}
                        </div>` : ''}
                    </div>`;

                case 'Altum Sustainability':
                    // API returns: currentRating, potentialRating, recommendedMeasures[], totalCO2Savings, totalCostSavings, investmentCost, paybackPeriod
                    const currentRating = data.currentRating || 'Unknown';
                    const potentialRating = data.potentialRating || 'Unknown';
                    const measures = data.recommendedMeasures || [];
                    const totalCO2Savings = data.totalCO2Savings || 0;
                    const totalCostSavings = data.totalCostSavings || 0;
                    const paybackPeriod = data.paybackPeriod || 0;

                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.25rem;">${currentRating} ‚Üí ${potentialRating}</div>
                        <div class="metric-label">Sustainability Potential</div>
                        ${totalCostSavings > 0 || totalCO2Savings > 0 ? `<div class="metric-secondary">
                            ${totalCostSavings > 0 ? `üí∞ Save <strong>‚Ç¨${totalCostSavings.toLocaleString()}</strong>/yr` : ''}
                            ${totalCO2Savings > 0 ? ` &nbsp;|&nbsp; üå± <strong>${totalCO2Savings.toLocaleString()}</strong> kg CO‚ÇÇ` : ''}
                        </div>` : ''}
                        ${paybackPeriod > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ‚è±Ô∏è Payback: <strong>${paybackPeriod.toFixed(1)}</strong> years
                        </div>` : ''}
                        ${measures.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìã <strong>${measures.length}</strong> recommended measures
                        </div>` : ''}
                    </div>`;

                case 'Flood Risk':
                    const riskLevel = data.riskLevel || 'Unknown';
                    const floodBadgeClass = riskLevel === 'Low' ? 'good' : riskLevel === 'Medium' ? 'moderate' : 'poor';
                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${floodBadgeClass}" style="font-size: 0.9rem; padding: 6px 14px;">${riskLevel} Risk</span>
                        </div>
                        <div class="metric-label">Flood Risk Assessment</div>
                        ${data.zoneName ? `<div class="metric-secondary">Zone: <strong>${data.zoneName}</strong></div>` : ''}
                    </div>`;

                case 'NDW Traffic':
                    return `<div class="metric-display">
                        <div class="metric-value">${data.incidentCount || 0}</div>
                        <div class="metric-label">Traffic Incidents</div>
                        <div class="metric-secondary">
                            üöó Avg speed: <strong>${data.averageSpeed || 'N/A'}</strong> km/h
                        </div>
                    </div>`;

                case 'WUR Soil Physicals':
                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.25rem;">${data.soilType || 'Unknown'}</div>
                        <div class="metric-label">Soil Type</div>
                        <div class="metric-secondary">
                            pH: <strong>${data.ph || 'N/A'}</strong> &nbsp;|&nbsp;
                            Organic: <strong>${data.organicMatter || 'N/A'}</strong>%
                        </div>
                    </div>`;

                case 'BRO Soil Map':
                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.1rem;">${data.soilType || data.description || 'Data available'}</div>
                        <div class="metric-label">Soil Classification</div>
                    </div>`;

                case 'SkyGeo Subsidence':
                    const subsidence = data.subsidenceRate || 0;
                    const subsidenceClass = subsidence > 5 ? 'poor' : subsidence > 2 ? 'moderate' : 'good';
                    return `<div class="metric-display">
                        <div class="metric-value">${subsidence} <span style="font-size: 1rem; font-weight: 500;">mm/yr</span></div>
                        <div class="metric-label">Subsidence Rate</div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${subsidenceClass}">${subsidence > 5 ? 'High' : subsidence > 2 ? 'Medium' : 'Low'} Risk</span>
                        </div>
                    </div>`;

                case 'Monument Status':
                    const hasStatus = data.status && data.status !== 'Not protected';
                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${hasStatus ? 'moderate' : 'good'}">${data.status || 'Not Protected'}</span>
                        </div>
                        <div class="metric-label">Heritage Status</div>
                        ${data.description ? `<div class="metric-secondary">${data.description}</div>` : ''}
                    </div>`;

                case 'BAG Address':
                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1rem; font-weight: 600;">${data.address || 'Address verified'}</div>
                        <div class="metric-label">Official BAG Registration</div>
                        ${data.coordinates ? `<div class="metric-secondary">üìç ${data.coordinates[1]?.toFixed(5)}, ${data.coordinates[0]?.toFixed(5)}</div>` : ''}
                    </div>`;

                case 'PDOK Platform':
                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1rem;">${data.zoningInfo || 'Data Available'}</div>
                        <div class="metric-label">Platform Data</div>
                        ${data.restrictions && data.restrictions.length > 0 ?
                            `<div class="metric-secondary">‚ö†Ô∏è <strong>${data.restrictions.length}</strong> restrictions noted</div>` : ''}
                    </div>`;

                case 'Land Use & Zoning':
                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.1rem;">${data.primaryUse || data.landUseType || 'Unknown'}</div>
                        <div class="metric-label">Land Use Classification</div>
                        ${data.zoningCode ? `<div class="metric-secondary">Zone Code: <strong>${data.zoningCode}</strong></div>` : ''}
                        ${data.zoningDetails ? `<div class="metric-secondary" style="margin-top: 0.25rem;">${data.zoningDetails}</div>` : ''}
                    </div>`;

                case 'Altum WOZ':
                    // API returns: wozValue, valueYear, buildingType, buildYear, surfaceArea
                    const wozValue = data.wozValue || 0;
                    const valueYear = data.valueYear || '';
                    const wozBuildingType = data.buildingType || 'Unknown';
                    const wozBuildYear = data.buildYear || 0;
                    const wozSurfaceArea = data.surfaceArea || 0;

                    return `<div class="metric-display">
                        <div class="metric-value">‚Ç¨${wozValue.toLocaleString()}</div>
                        <div class="metric-label">WOZ Tax Value${valueYear ? ` (${valueYear})` : ''}</div>
                        <div class="metric-secondary">
                            üè† <strong>${wozBuildingType}</strong>
                            ${wozBuildYear > 0 ? ` &nbsp;|&nbsp; üìÖ Built: <strong>${wozBuildYear}</strong>` : ''}
                        </div>
                        ${wozSurfaceArea > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìê Surface: <strong>${wozSurfaceArea}m¬≤</strong>
                        </div>` : ''}
                    </div>`;

                case 'Altum Transactions':
                    // API returns: transactions[], totalCount
                    const transactions = data.transactions || [];
                    const txCount = data.totalCount || transactions.length;
                    const latestTx = transactions[0];

                    return `<div class="metric-display">
                        <div class="metric-value">${txCount}</div>
                        <div class="metric-label">Historical Transactions</div>
                        ${latestTx ? `<div class="metric-secondary">
                            üí∞ Last sale: <strong>‚Ç¨${(latestTx.purchasePrice || 0).toLocaleString()}</strong>
                            ${latestTx.date ? ` (${latestTx.date})` : ''}
                        </div>` : '<div class="metric-secondary">No transaction history available</div>'}
                        ${latestTx && latestTx.surfaceArea ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìê <strong>${latestTx.surfaceArea}m¬≤</strong> &nbsp;|&nbsp;
                            ‚Ç¨${Math.round((latestTx.purchasePrice || 0) / latestTx.surfaceArea).toLocaleString()}/m¬≤
                        </div>` : ''}
                    </div>`;

                case 'Kadaster Object Info':
                    // API returns: ownerName, cadastralReference, wozValue, energyLabel, municipalTaxes, surfaceArea, plotSize, buildingType, buildYear
                    const kdWOZ = data.wozValue || 0;
                    const kdEnergyLabel = data.energyLabel || 'Unknown';
                    const kdSurface = data.surfaceArea || 0;
                    const kdPlot = data.plotSize || 0;
                    const kdBuildType = data.buildingType || 'Unknown';
                    const kdBuildYear = data.buildYear || 0;
                    const kdLabelClass = ['A++++', 'A+++', 'A++', 'A+', 'A', 'B'].includes(kdEnergyLabel) ? 'good' : ['C', 'D'].includes(kdEnergyLabel) ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        ${kdWOZ > 0 ? `<div class="metric-value">‚Ç¨${kdWOZ.toLocaleString()}</div>
                        <div class="metric-label">Kadaster WOZ Value</div>` :
                        `<div class="metric-value" style="font-size: 1.25rem;">${kdBuildType}</div>
                        <div class="metric-label">Property Type</div>`}
                        <div class="metric-secondary" style="margin-top: 0.5rem;">
                            ‚ö° Energy: <span class="status-badge ${kdLabelClass}">${kdEnergyLabel}</span>
                            ${kdBuildYear > 0 ? ` &nbsp;|&nbsp; üìÖ Built: <strong>${kdBuildYear}</strong>` : ''}
                        </div>
                        ${kdSurface > 0 || kdPlot > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${kdSurface > 0 ? `üìê Living: <strong>${kdSurface}m¬≤</strong>` : ''}
                            ${kdPlot > 0 ? ` &nbsp;|&nbsp; üè° Plot: <strong>${kdPlot}m¬≤</strong>` : ''}
                        </div>` : ''}
                    </div>`;

                case 'Matrixian Property Value+':
                    // API returns: marketValue, valuationDate, confidence, comparableProperties[], features, pricePerSqm
                    const marketValue = data.marketValue || 0;
                    const confidence = data.confidence || 0;
                    const pricePerSqm = data.pricePerSqm || 0;
                    const comparables = data.comparableProperties || [];
                    const confidenceClass = confidence >= 80 ? 'good' : confidence >= 60 ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value">‚Ç¨${marketValue.toLocaleString()}</div>
                        <div class="metric-label">Estimated Market Value</div>
                        <div class="metric-secondary">
                            üìä Confidence: <span class="status-badge ${confidenceClass}">${confidence.toFixed(0)}%</span>
                            ${pricePerSqm > 0 ? ` &nbsp;|&nbsp; ‚Ç¨${pricePerSqm.toLocaleString()}/m¬≤` : ''}
                        </div>
                        ${comparables.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üèòÔ∏è Based on <strong>${comparables.length}</strong> comparable sales
                        </div>` : ''}
                    </div>`;

                case 'Digital Delta Water Quality':
                    // API returns: waterLevel, waterQuality, parameters, nearestWater, distance, lastMeasured
                    const waterQuality = data.waterQuality || 'Unknown';
                    const waterLevel = data.waterLevel || 0;
                    const nearestWater = data.nearestWater || '';
                    const waterDistance = data.distance || 0;
                    const qualityClass = waterQuality === 'Excellent' || waterQuality === 'Good' ? 'good' : waterQuality === 'Fair' ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${qualityClass}" style="font-size: 0.9rem; padding: 6px 14px;">üíß ${waterQuality}</span>
                        </div>
                        <div class="metric-label">Water Quality</div>
                        ${nearestWater ? `<div class="metric-secondary">
                            üìç ${nearestWater}${waterDistance > 0 ? ` (${Math.round(waterDistance)}m)` : ''}
                        </div>` : ''}
                        ${waterLevel !== 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìè Water level: <strong>${waterLevel.toFixed(2)}m</strong> (NAP)
                        </div>` : ''}
                    </div>`;

                case 'CBS Safety Experience':
                    // API returns: safetyScore, safetyPerception, crimeRate, crimeTypes, policeResponse, yearOverYearChange
                    const safetyScore = data.safetyScore || 0;
                    const safetyPerception = data.safetyPerception || 'Unknown';
                    const crimeRate = data.crimeRate || 0;
                    const policeResponse = data.policeResponse || 0;
                    const yoyChange = data.yearOverYearChange || 0;
                    const safetyClass = safetyPerception === 'Very Safe' || safetyPerception === 'Safe' ? 'good' : safetyPerception === 'Moderate' ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value">${safetyScore.toFixed(0)}<span style="font-size: 1rem; font-weight: 500;">/100</span></div>
                        <div class="metric-label">Safety Score</div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${safetyClass}">${safetyPerception}</span>
                        </div>
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üöî Crime: <strong>${crimeRate.toFixed(1)}</strong>/1000 residents
                            ${policeResponse > 0 ? ` &nbsp;|&nbsp; üö® Response: <strong>${policeResponse.toFixed(0)}</strong>min` : ''}
                        </div>
                        ${yoyChange !== 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${yoyChange > 0 ? 'üìà' : 'üìâ'} YoY: <strong>${yoyChange > 0 ? '+' : ''}${yoyChange.toFixed(1)}%</strong>
                        </div>` : ''}
                    </div>`;

                case 'Schiphol Flight Noise':
                    // API returns: dailyFlights, noiseLevel, peakHours[], flightPaths[], nightFlights, noiseContour
                    const dailyFlights = data.dailyFlights || 0;
                    const flightNoiseLevel = data.noiseLevel || 0;
                    const nightFlights = data.nightFlights || 0;
                    const noiseContour = data.noiseContour || '';
                    const flightPaths = data.flightPaths || [];
                    const flightNoiseClass = flightNoiseLevel < 45 ? 'good' : flightNoiseLevel < 55 ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value">${flightNoiseLevel.toFixed(0)} <span style="font-size: 1rem; font-weight: 500;">dB(A)</span></div>
                        <div class="metric-label">Aviation Noise Level</div>
                        <div class="metric-secondary">
                            ‚úàÔ∏è <strong>${dailyFlights}</strong> flights/day
                            ${nightFlights > 0 ? ` &nbsp;|&nbsp; üåô <strong>${nightFlights}</strong> at night` : ''}
                        </div>
                        ${noiseContour ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç Noise zone: <span class="status-badge ${flightNoiseClass}">Ke ${noiseContour}</span>
                        </div>` : ''}
                        ${flightPaths.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üõ´ <strong>${flightPaths.length}</strong> flight paths nearby
                        </div>` : ''}
                    </div>`;

                case 'Soil Quality':
                    // API returns: contaminationLevel, contaminants[], qualityZone, restrictedUse, lastTested
                    const contamLevel = data.contaminationLevel || 'Unknown';
                    const contaminants = data.contaminants || [];
                    const restrictedUse = data.restrictedUse || false;
                    const contamClass = contamLevel === 'Clean' ? 'good' : contamLevel === 'Light' ? 'moderate' : contamLevel === 'Unknown' ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${contamClass}" style="font-size: 0.9rem; padding: 6px 14px;">üß™ ${contamLevel}</span>
                            ${restrictedUse ? '<span class="status-badge poor" style="margin-left: 4px;">‚ö†Ô∏è Restricted Use</span>' : ''}
                        </div>
                        <div class="metric-label">Soil Contamination</div>
                        ${contaminants.length > 0 ? `<div class="metric-secondary">
                            Detected: ${contaminants.slice(0, 3).map(c => `<strong>${c}</strong>`).join(', ')}
                            ${contaminants.length > 3 ? ` +${contaminants.length - 3} more` : ''}
                        </div>` : '<div class="metric-secondary">No contaminants detected</div>'}
                    </div>`;

                case 'Stratopo Environment':
                    // API returns: environmentScore, totalVariables, pollutionIndex, urbanizationLevel, environmentFactors, esgRating, recommendations[]
                    const envScore = data.environmentScore || 0;
                    const esgRating = data.esgRating || 'Unknown';
                    const urbanLevel = data.urbanizationLevel || 'Unknown';
                    const pollutionIdx = data.pollutionIndex || 0;
                    const recommendations = data.recommendations || [];
                    const esgClass = ['A+', 'A', 'B+', 'B'].includes(esgRating) ? 'good' : ['C+', 'C'].includes(esgRating) ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value">${envScore.toFixed(0)}<span style="font-size: 1rem; font-weight: 500;">/100</span></div>
                        <div class="metric-label">Environment Score</div>
                        <div class="metric-secondary" style="margin-top: 0.5rem;">
                            üåø ESG: <span class="status-badge ${esgClass}">${esgRating}</span>
                            &nbsp;|&nbsp; üèôÔ∏è <strong>${urbanLevel}</strong>
                        </div>
                        ${pollutionIdx > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üí® Pollution index: <strong>${pollutionIdx.toFixed(1)}</strong>
                        </div>` : ''}
                        ${recommendations.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üí° <strong>${recommendations.length}</strong> recommendations available
                        </div>` : ''}
                    </div>`;

                // Default fallback - smart extraction for unknown APIs
                default:
                    return formatUnknownData(apiName, data);
            }
        }

        // Smart formatter for unknown data structures
        function formatUnknownData(apiName, data) {
            if (!data) return '';

            // If it's an array, show count and sample items
            if (Array.isArray(data)) {
                const count = data.length;
                const sampleItems = data.slice(0, 3).map(item => {
                    if (typeof item === 'string') return item;
                    if (typeof item === 'object') return item.name || item.naam || item.title || item.type || JSON.stringify(item).substring(0, 30);
                    return String(item);
                });

                return `<div class="metric-display">
                    <div class="metric-value">${count}</div>
                    <div class="metric-label">Items Found</div>
                    ${sampleItems.length > 0 ? `<div class="metric-secondary">${sampleItems.join(' ‚Ä¢ ')}</div>` : ''}
                </div>`;
            }

            // If it's an object, extract key metrics
            if (typeof data === 'object') {
                const keys = Object.keys(data);

                // Look for common numeric fields to highlight
                const numericFields = ['total', 'count', 'aantal', 'population', 'inhabitants', 'area', 'distance', 'value', 'score'];
                let primaryMetric = null;
                let primaryLabel = null;

                for (const field of numericFields) {
                    for (const key of keys) {
                        if (key.toLowerCase().includes(field) && typeof data[key] === 'number') {
                            primaryMetric = data[key];
                            primaryLabel = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase()).trim();
                            break;
                        }
                    }
                    if (primaryMetric !== null) break;
                }

                // Build secondary info from other fields
                const secondaryFields = [];
                for (const key of keys.slice(0, 5)) {
                    const val = data[key];
                    if (key === primaryLabel?.replace(/ /g, '')) continue;

                    if (typeof val === 'number') {
                        secondaryFields.push(`${key}: <strong>${val.toLocaleString()}</strong>`);
                    } else if (typeof val === 'string' && val.length < 30) {
                        secondaryFields.push(`${key}: <strong>${val}</strong>`);
                    } else if (Array.isArray(val)) {
                        secondaryFields.push(`${key}: <strong>${val.length} items</strong>`);
                    }
                }

                if (primaryMetric !== null) {
                    return `<div class="metric-display">
                        <div class="metric-value">${typeof primaryMetric === 'number' ? primaryMetric.toLocaleString() : primaryMetric}</div>
                        <div class="metric-label">${primaryLabel}</div>
                        ${secondaryFields.length > 0 ? `<div class="metric-secondary">${secondaryFields.slice(0, 3).join(' &nbsp;|&nbsp; ')}</div>` : ''}
                    </div>`;
                }

                // No numeric primary found, show first few fields
                if (secondaryFields.length > 0) {
                    return `<div class="metric-display">
                        <div class="metric-label" style="color: var(--success); margin-bottom: 0.5rem;">‚úì Data Retrieved</div>
                        <div class="metric-secondary">${secondaryFields.slice(0, 4).join('<br>')}</div>
                    </div>`;
                }
            }

            // Fallback for primitives or empty objects
            return `<div class="metric-display">
                <div class="metric-label" style="color: var(--success);">‚úì Data retrieved successfully</div>
            </div>`;
        }

        function renderApiResults() {
            const isMobile = window.innerWidth <= 768;
            const targetContainer = isMobile ? document.getElementById('results-mobile') : document.getElementById('results-desktop');

            if (!targetContainer) {
                return;
            }

            if (!currentResponse || !currentResponse.apiResults) {
                targetContainer.innerHTML = '';
                document.body.classList.remove('has-results');
                return;
            }

            const grouped = currentResponse.apiResults;
            const allResults = [...grouped.free, ...grouped.freemium, ...grouped.premium];
            const filtered = allResults.filter(result => enabledAPIs.has(result.name));

            const successCount = filtered.filter(r => r.status === 'success').length;
            const errorCount = filtered.filter(r => r.status === 'error').length;
            const notConfiguredCount = filtered.filter(r => r.status === 'not_configured').length;

            let html = '<div class="summary-notification">';
            html += `<strong>Property Intelligence Report</strong>`;
            html += `<div class="summary-stats">`;
            html += `<span class="summary-stat">‚úì ${successCount} successful</span>`;
            html += `<span class="summary-stat">‚úó ${errorCount} errors</span>`;
            html += `<span class="summary-stat">‚ö† ${notConfiguredCount} not configured</span>`;
            html += `</div></div>`;

            // Helper function to render a section
            const renderSection = (title, icon, results) => {
                if (results.length === 0) return '';
                const sectionResults = results.filter(result => enabledAPIs.has(result.name));
                if (sectionResults.length === 0) return '';

                // Sort results: success first, then error, then not_configured
                const statusPriority = { 'success': 0, 'error': 1, 'not_configured': 2 };
                sectionResults.sort((a, b) => {
                    const priorityA = statusPriority[a.status] ?? 3;
                    const priorityB = statusPriority[b.status] ?? 3;
                    return priorityA - priorityB;
                });

                let sectionHtml = `<div class="mb-5">
                    <div class="section-header">
                        <span class="section-icon">${icon}</span>
                        <h4>${title}</h4>
                    </div>
                    <div class="api-results-grid">`;

                sectionResults.forEach(result => {
                    const statusClass = result.status === 'success' ? 'success' : result.status === 'error' ? 'error' : 'warning';
                    const errorMessage = result.error ? `<p class="metric-secondary" style="color: var(--danger);">${result.error}</p>` : '';
                    const formattedData = result.status === 'success' ? formatApiData(result.name, result.data) : '';
                    const dataBlock = result.data
                        ? `<details class="raw-data-toggle">
                                <summary>View Raw Data</summary>
                                <pre>${JSON.stringify(result.data, null, 2)}</pre>
                            </details>`
                        : '';

                    sectionHtml += `
                        <div class="result-card">
                            <div class="card-header-title">
                                <span class="status-dot ${statusClass}"></span>
                                ${result.name}
                            </div>
                            ${formattedData}
                            ${errorMessage}
                            ${dataBlock}
                        </div>
                    `;
                });

                sectionHtml += '</div></div>';
                return sectionHtml;
            };

            html += renderSection('Free APIs', 'üåê', grouped.free);
            html += renderSection('Freemium APIs', 'üîë', grouped.freemium);
            html += renderSection('Premium APIs', 'üí∞', grouped.premium);

            targetContainer.innerHTML = html;
            if (filtered.length > 0) {
                document.body.classList.add('has-results');
            } else {
                document.body.classList.remove('has-results');
            }
        }

        // Export data as CSV
        function exportCSV() {
            if (!currentResponse) {
                alert('No results to export');
                return;
            }

            const rows = [];
            rows.push(['Address', currentResponse.address]);
            rows.push(['Latitude', currentResponse.coordinates[1]]);
            rows.push(['Longitude', currentResponse.coordinates[0]]);
            rows.push([]);

            const grouped = currentResponse.apiResults;
            const allResults = [...grouped.free, ...grouped.freemium, ...grouped.premium];

            rows.push(['API Name', 'Category', 'Status', 'Data']);
            allResults
                .filter(r => enabledAPIs.has(r.name))
                .forEach(result => {
                    const dataStr = result.data ? JSON.stringify(result.data) : result.error || '';
                    rows.push([result.name, result.category, result.status, dataStr]);
                });

            const csvContent = rows.map(row =>
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `addressiq_${currentResponse.address.replace(/[^a-zA-Z0-9]/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Open settings modal
        function openSettings() {
            if (!currentResponse) {
                alert('Search for an address first');
                return;
            }

            const grouped = currentResponse.apiResults;
            const allAPIs = [...grouped.free, ...grouped.freemium, ...grouped.premium].map(r => r.name);

            let html = `
                <div class="modal is-active" id="settings-modal">
                    <div class="modal-background" onclick="closeSettings()"></div>
                    <div class="modal-card">
                        <header class="modal-card-head">
                            <p class="modal-card-title">API Settings</p>
                            <button class="delete" onclick="closeSettings()"></button>
                        </header>
                        <section class="modal-card-body">
                            <div class="buttons mb-3">
                                <button class="button is-success is-small" onclick="selectAllAPIs()">Select All</button>
                                <button class="button is-danger is-small" onclick="deselectAllAPIs()">Deselect All</button>
                            </div>
                            <div id="api-checkboxes">
            `;

            allAPIs.forEach(apiName => {
                const checked = enabledAPIs.has(apiName) ? 'checked' : '';
                html += `
                    <label class="checkbox is-block mb-2">
                        <input type="checkbox" value="${apiName}" ${checked} onchange="toggleAPI('${apiName}')">
                        ${apiName}
                    </label>
                `;
            });

            html += `
                            </div>
                        </section>
                        <footer class="modal-card-foot">
                            <button class="button is-success" onclick="saveSettings()">Save</button>
                            <button class="button" onclick="closeSettings()">Cancel</button>
                        </footer>
                    </div>
                </div>
            `;

            document.getElementById('modal-target').innerHTML = html;
        }

        function closeSettings() {
            document.getElementById('modal-target').innerHTML = '';
        }

        function toggleAPI(apiName) {
            if (enabledAPIs.has(apiName)) {
                enabledAPIs.delete(apiName);
            } else {
                enabledAPIs.add(apiName);
            }
            renderApiResults();
        }

        function selectAllAPIs() {
            if (!currentResponse) return;
            const grouped = currentResponse.apiResults;
            const allAPIs = [...grouped.free, ...grouped.freemium, ...grouped.premium];
            allAPIs.forEach(r => enabledAPIs.add(r.name));
            document.querySelectorAll('#api-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
            renderApiResults();
        }

        function deselectAllAPIs() {
            enabledAPIs.clear();
            document.querySelectorAll('#api-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
            renderApiResults();
        }

        function saveSettings() {
            localStorage.setItem('enabledAPIs', JSON.stringify([...enabledAPIs]));
            closeSettings();
            renderApiResults();
            alert('Settings saved! Enabled APIs: ' + enabledAPIs.size);
        }
    </script>
</body>
<div id="modal-target"></div>
</html>

