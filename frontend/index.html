<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddressIQ - Dutch Property Intelligence</title>
    <!-- Google Fonts - Inter for clean modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Bulma CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bulma@1/css/bulma.min.css" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <style>
        /*
         * AddressIQ Design System v4
         * Larger typography, better space utilisation
         */
        :root {
            /* Primary - sophisticated teal accent */
            --primary: #0d9488;
            --primary-hover: #0f766e;
            --primary-light: #14b8a6;

            /* Neutral palette */
            --bg-page: #f8f9fa;
            --bg-card: #ffffff;
            --bg-card-alt: #f3f4f6;
            --bg-dark: #1f2937;
            --bg-section: #f9fafb;

            /* Text - crisp, high contrast */
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-muted: #6b7280;
            --text-on-primary: #ffffff;

            /* Status */
            --success: #059669;
            --success-bg: #ecfdf5;
            --warning: #d97706;
            --warning-bg: #fffbeb;
            --danger: #dc2626;
            --danger-bg: #fef2f2;
            --info: #0891b2;
            --info-bg: #ecfeff;

            /* Borders */
            --border: #e5e7eb;
            --border-strong: #d1d5db;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.08);

            /* Spacing */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
        }

        * { box-sizing: border-box; }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-size: 17px;
            line-height: 1.5;
            color: var(--text-primary);
            background: var(--bg-page);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .full-height-columns {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .full-height-columns .columns {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }

        /* Navbar */
        .navbar.is-primary {
            background: var(--bg-dark);
            box-shadow: none;
            padding: 0;
            min-height: 52px;
        }
        .navbar-brand .navbar-item {
            font-weight: 700;
            font-size: 1.375rem;
            letter-spacing: -0.3px;
            color: white !important;
            gap: 0.5rem;
            padding: 0 1.25rem;
        }
        .navbar-brand .navbar-item:hover {
            background: transparent !important;
        }
        .logo-icon {
            font-size: 1.5rem;
        }
        .navbar-end .tag {
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.6);
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 4px;
        }

        /* Map & Layout */
        #map { width: 100%; height: 100%; }
        #map-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
        }
        .sidebar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 58%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }
        .sidebar-content {
            height: 100%;
            overflow-y: auto;
            padding: 1rem 1.5rem 1.5rem;
            pointer-events: auto;
            direction: rtl;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .sidebar-content > * { direction: ltr; }
        .sidebar-overlay, .sidebar-content { background: transparent; }

        /* Scrollbar */
        .sidebar-content::-webkit-scrollbar { width: 6px; }
        .sidebar-content::-webkit-scrollbar-track { background: transparent; }
        .sidebar-content::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 3px; }

        /* Search Panel - Full Width */
        .search-panel {
            pointer-events: auto;
        }
        .search-panel .box {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            padding: 1.25rem;
        }
        .search-form-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }
        .search-form-row .field {
            flex: 1;
            margin-bottom: 0;
        }
        .search-form-row .field:last-child {
            flex: 0 0 auto;
        }
        .search-panel .label {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 0.375rem;
        }
        .search-panel .input {
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 1.125rem;
            padding: 0.75rem 1rem;
            height: auto;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
            background: var(--bg-card);
        }
        .search-panel .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
            outline: none;
        }
        .search-panel .button.is-primary {
            background: var(--primary);
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 1.0625rem;
            padding: 0.75rem 2rem;
            height: auto;
            transition: background 0.15s ease;
        }
        .search-panel .button.is-primary:hover {
            background: var(--primary-hover);
        }

        /* Address Header Card */
        .address-header-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        .address-info { flex: 1; min-width: 0; }
        .address-title {
            font-size: 1.625rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            margin: 0 0 0.25rem;
            line-height: 1.2;
        }
        .address-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            margin-top: 0.5rem;
        }
        .address-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 5px;
            font-size: 0.9375rem;
            font-weight: 500;
            background: var(--bg-card-alt);
            color: var(--text-secondary);
        }
        .address-tag strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        .address-actions {
            display: flex;
            gap: 0.625rem;
            flex-shrink: 0;
        }
        .address-actions .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            font-weight: 600;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .address-actions .btn:hover {
            background: var(--bg-card-alt);
            border-color: var(--border-strong);
            color: var(--text-primary);
        }
        .address-actions .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .address-actions .btn-primary:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        /* Results container */
        .results-wrapper { margin-top: 0; pointer-events: auto; }
        .desktop-results { min-height: 0; }
        body:not(.has-results) .desktop-results { display: none; }
        .mobile-results { display: none; }

        /* API Results Grid */
        .api-results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 0.875rem;
        }

        /* Result Cards */
        .result-card {
            background: var(--bg-card) !important;
            border-radius: var(--radius-md) !important;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border) !important;
            padding: 1.125rem 1.25rem !important;
            transition: box-shadow 0.15s ease, border-color 0.15s ease;
            margin: 0 !important;
        }
        .result-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--border-strong) !important;
        }
        .card-header-title {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9375rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        .status-dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-dot.success { background: var(--success); }
        .status-dot.error { background: var(--danger); }
        .status-dot.warning { background: var(--warning); }

        /* Metric Display - LARGER */
        .metric-display {
            margin: 0.5rem 0 0.375rem;
        }
        .metric-value {
            font-size: 2.75rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            letter-spacing: -0.02em;
            font-feature-settings: 'tnum';
        }
        .metric-value span {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-left: 0.125rem;
        }
        .metric-label {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-top: 0.375rem;
        }
        .metric-secondary {
            font-size: 1.0625rem;
            color: var(--text-secondary);
            margin-top: 0.625rem;
            line-height: 1.5;
        }
        .metric-secondary strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        .timestamp {
            font-size: 0.75rem;
            font-weight: 400;
            color: var(--text-muted);
            opacity: 0.8;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.875rem;
            border-radius: 5px;
            font-size: 0.9375rem;
            font-weight: 600;
        }
        .status-badge.good { background: var(--success-bg); color: var(--success); }
        .status-badge.moderate { background: var(--warning-bg); color: var(--warning); }
        .status-badge.poor { background: var(--danger-bg); color: var(--danger); }

        /* Raw Data Toggle */
        .raw-data-toggle {
            margin-top: 1rem;
            padding-top: 0.875rem;
            border-top: 1px solid var(--border);
        }
        .raw-data-toggle summary {
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
            transition: color 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        .raw-data-toggle summary:hover { color: var(--text-secondary); }
        .raw-data-toggle summary::before {
            content: '{ }';
            font-family: monospace;
            font-size: 0.8125rem;
        }
        .raw-data-toggle pre {
            margin-top: 0.625rem;
            padding: 0.875rem;
            background: var(--bg-dark);
            color: #a1a1aa;
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Fira Code', 'Monaco', monospace;
            line-height: 1.4;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            margin-bottom: 0.875rem;
            padding-bottom: 0.625rem;
            border-bottom: 2px solid var(--border);
        }
        .section-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .section-icon { font-size: 1.25rem; }
        .summary-stats-inline {
            display: flex;
            gap: 1rem;
            margin-left: auto;
        }
        .summary-stat-inline {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-muted);
        }
        .summary-stat-inline .count {
            font-weight: 700;
            color: var(--text-primary);
        }
        .summary-stat-inline.success .count { color: var(--success); }

        /* Misc */
        .result-card pre { word-break: break-all; white-space: pre-wrap; }
        .tier-section { margin-bottom: 1.5rem; }
        .tier-section:last-child { margin-bottom: 0; }

        /* Mobile Layout */
        @media screen and (max-width: 768px) {
            html, body { font-size: 16px; }
            .navbar { position: fixed; top: 0; left: 0; right: 0; z-index: 40; min-height: 48px; }
            .navbar-brand .navbar-item { font-size: 1.25rem; }
            .full-height-columns { height: 100%; }
            .full-height-columns .columns { position: static; }
            #map-container {
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                width: 100%; height: 100%;
                z-index: 1;
            }
            .sidebar-overlay {
                position: fixed;
                inset: 0;
                width: 100%;
                height: 100%;
                display: flex;
                pointer-events: none;
                padding: 0;
                z-index: 30;
            }
            .sidebar-content {
                direction: ltr;
                padding: 0;
                height: 100%;
                width: 100%;
                overflow-y: auto;
                overflow-x: hidden;
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                pointer-events: auto;
                padding-top: calc(48px + 0.75rem);
                padding-bottom: 1.5rem;
            }
            .search-panel {
                pointer-events: auto;
                margin: 0 0.875rem;
                flex-shrink: 0;
            }
            body:not(.has-results) .search-panel {
                margin-top: auto;
                margin-bottom: 1.25rem;
            }
            body.has-results .search-panel {
                margin-top: 0;
                margin-bottom: 0;
            }
            .search-form-row {
                flex-direction: column;
                gap: 0.75rem;
            }
            .search-form-row .field:last-child {
                flex: 1;
            }
            .search-panel .button.is-primary {
                width: 100%;
            }
            .desktop-results { display: none !important; }
            .mobile-results {
                margin: 0 0.875rem;
                pointer-events: auto;
                display: block;
                flex-shrink: 0;
            }
            body:not(.has-results) .mobile-results { display: none; }
            .mobile-results .api-results-grid { grid-template-columns: 1fr !important; }
            .mobile-results .address-header-card {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            .mobile-results .address-title { font-size: 1.375rem; }
            .mobile-results .address-actions {
                margin-top: 0.75rem;
                width: 100%;
            }
            .mobile-results .address-actions .btn {
                flex: 1;
                justify-content: center;
            }
            .metric-value { font-size: 2.25rem; }
        }
    </style>
</head>
<body>
    <div class="full-height-columns">
        <nav class="navbar is-primary">
            <div class="navbar-brand">
                <a class="navbar-item" href="#">
                    <span class="logo-icon">üè†</span>
                    AddressIQ
                </a>
            </div>
            <div class="navbar-end">
                <div class="navbar-item">
                    <span class="tag is-light is-size-7" id="build-info">Loading...</span>
                </div>
            </div>
        </nav>
        <div class="columns is-gapless">
            <!-- Map (full background) -->
            <div class="column" id="map-container">
                <div id="map"></div>
            </div>
            <!-- Floating Sidebar -->
            <div class="sidebar-overlay">
                <div class="sidebar-content">
                    <div class="search-panel">
                        <div class="box">
                            <form
                                id="search-form"
                                hx-target="#results-container"
                                hx-swap="innerHTML"
                            >
                                <div class="search-form-row">
                                    <div class="field">
                                        <label class="label" for="postcode">Postcode</label>
                                        <div class="control">
                                            <input class="input" type="text" name="postcode" id="postcode" placeholder="1016GV" required />
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label" for="houseNumber">House Number</label>
                                        <div class="control">
                                            <input class="input" type="text" name="houseNumber" id="houseNumber" placeholder="263" required />
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">&nbsp;</label>
                                        <div class="control">
                                            <button type="submit" class="button is-primary" hx-disabled-elt="this">Search</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="results-wrapper desktop-results">
                        <div id="results-desktop"></div>
                    </div>
                    <div class="results-wrapper mobile-results">
                        <div id="results-mobile"></div>
                    </div>
                    <div id="results-container" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
    let map;
    let currentResponse = null;
    let enabledAPIs = new Set(); // Track which APIs are enabled
    let apiHost = '';

        // Fetch build info from API
        async function fetchBuildInfo() {
            const buildInfoEl = document.getElementById('build-info');
            if (!buildInfoEl) {
                return;
            }
            try {
                const response = await fetch(apiHost + '/build-info');
                const data = await response.json();

                const repoUrl = 'https://github.com/iman-hussain/AddressIQ/commit/';
                const buildLine = (label, info) => {
                    if (!info || !info.commit || info.commit === 'unknown') {
                        return `${label}: (unknown)`;
                    }
                    const shortCommit = info.commit.length > 7 ? info.commit.substring(0, 7) : info.commit;
                    return `${label}: (<a href="${repoUrl}${info.commit}" target="_blank" rel="noopener noreferrer">${shortCommit}</a>)`;
                };

                const backendDate = data?.backend?.date ? new Date(data.backend.date) : null;
                const frontendDate = data?.frontend?.date ? new Date(data.frontend.date) : null;
                const mostRecentDate = [backendDate, frontendDate]
                    .filter(d => d instanceof Date && !isNaN(d.getTime()))
                    .sort((a, b) => b - a)[0];

                const formattedDate = mostRecentDate
                    ? mostRecentDate.toLocaleString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    })
                    : 'unknown';

                buildInfoEl.innerHTML = `${buildLine('Frontend Build', data.frontend)} ${buildLine('Backend Build', data.backend)} | ${formattedDate}`;
            } catch (error) {
                console.warn('Failed to fetch build info:', error);
                buildInfoEl.textContent = 'Build info unavailable';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Define apiHost based on hostname
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                apiHost = 'http://localhost:8080';
            } else {
                apiHost = 'https://api.addressiq.imanhussain.com';
            }

            // Populate build info dynamically from API
            fetchBuildInfo();

            map = new maplibregl.Map({
                container: 'map',
                style: 'https://demotiles.maplibre.org/style.json',
                center: [5.3878, 52.1561], // Center on Netherlands
                zoom: 7,
                minZoom: 6,
                maxZoom: 18,
                maxBounds: [
                    [2.5, 50.5],   // Southwest corner (just into the sea, below Belgium)
                    [8.5, 54.2]    // Northeast corner (just into Germany)
                ]
            });
            window.map = map;

            const applyMapPadding = () => {
                if (!map) return;
                if (window.innerWidth > 1024) {
                    map.setPadding({ left: window.innerWidth * 0.35, right: 40, top: 20, bottom: 40 });
                } else if (window.innerWidth > 768) {
                    map.setPadding({ left: window.innerWidth * 0.25, right: 20, top: 20, bottom: 40 });
                } else {
                    map.setPadding({ left: 0, right: 0, top: 0, bottom: 0 });
                }
            };
            applyMapPadding();
            window.addEventListener('resize', applyMapPadding);

            // Set hx-post on the form
            const searchForm = document.getElementById('search-form');
            searchForm.setAttribute('hx-post', apiHost + '/search');

            // Process with HTMX
            htmx.process(searchForm);

            // Load API preferences from localStorage
            const savedAPIs = localStorage.getItem('enabledAPIs');
            if (savedAPIs) {
                enabledAPIs = new Set(JSON.parse(savedAPIs));
            } else {
                // Default: all enabled
                enabledAPIs = new Set([
                    'BAG Address', 'Kadaster Object Info', 'Altum WOZ', 'Matrixian Property Value+',
                    'Altum Transactions', 'KNMI Weather', 'KNMI Solar', 'Luchtmeetnet Air Quality',
                    'Noise Pollution', 'CBS Population', 'CBS Square Statistics', 'WUR Soil Physicals',
                    'SkyGeo Subsidence', 'Soil Quality', 'BRO Soil Map', 'Altum Energy & Climate',
                    'Altum Sustainability', 'NDW Traffic', 'openOV Public Transport', 'Parking Availability',
                    'Flood Risk', 'Digital Delta Water Quality', 'CBS Safety Experience', 'Schiphol Flight Noise',
                    'Green Spaces', 'Education Facilities', 'Building Permits', 'Facilities & Amenities',
                    'AHN Height Model', 'Monument Status', 'PDOK Platform', 'Stratopo Environment', 'Land Use & Zoning'
                ]);
            }
        });

        document.body.addEventListener('htmx:beforeRequest', function (event) {
            const trigger = event.target;
            if (trigger && trigger.tagName === 'FORM' && trigger.getAttribute('hx-target') === '#results-container') {
                document.body.classList.remove('has-results');
                const isMobile = window.innerWidth <= 768;
                const targetContainer = isMobile ? document.getElementById('results-mobile') : document.getElementById('results-desktop');
                if (targetContainer) targetContainer.innerHTML = '';
            }
        });

        // Update the map with new GeoJSON and zoom/circle location
        function updateMap(geojsonString) {
            if (!map) return;
            let geojson;
            try {
                geojson = JSON.parse(geojsonString);
            } catch (e) {
                console.error('Invalid GeoJSON:', e);
                return;
            }

            // Remove old sources/layers if they exist
            if (map.getLayer('parcel-layer')) map.removeLayer('parcel-layer');
            if (map.getSource('parcel-source')) map.removeSource('parcel-source');
            if (map.getLayer('location-circle')) map.removeLayer('location-circle');
            if (map.getSource('location-point')) map.removeSource('location-point');

            // Add parcel polygon if present
            if (geojson.type === 'Polygon' || geojson.type === 'FeatureCollection') {
                map.addSource('parcel-source', {
                    type: 'geojson',
                    data: geojson
                });
                map.addLayer({
                    id: 'parcel-layer',
                    type: 'fill',
                    source: 'parcel-source',
                    paint: {
                        'fill-color': '#2563eb', // blue
                        'fill-opacity': 0.5,
                        'fill-outline-color': '#000'
                    }
                });
            }

            // If we have a point, zoom and circle it
            let point = null;
            if (geojson.type === 'Point' && Array.isArray(geojson.coordinates)) {
                point = geojson.coordinates;
            } else if (geojson.type === 'Feature' && geojson.geometry && geojson.geometry.type === 'Point') {
                point = geojson.geometry.coordinates;
            } else if (geojson.type === 'FeatureCollection') {
                for (const feat of geojson.features) {
                    if (feat.geometry && feat.geometry.type === 'Point') {
                        point = feat.geometry.coordinates;
                        break;
                    }
                }
            }

            if (point) {
                map.flyTo({ center: point, zoom: 17 });
                map.addSource('location-point', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: { type: 'Point', coordinates: point }
                    }
                });
                map.addLayer({
                    id: 'location-circle',
                    type: 'circle',
                    source: 'location-point',
                    paint: {
                        'circle-radius': 18,
                        'circle-color': '#e63946',
                        'circle-opacity': 0.7,
                        'circle-stroke-width': 3,
                        'circle-stroke-color': '#fff'
                    }
                });
            } else if (geojson.type === 'Polygon' && Array.isArray(geojson.coordinates)) {
                // Fit map to bounds for polygon
                const coords = geojson.coordinates.flat(2);
                let minLng = coords[0][0], minLat = coords[0][1], maxLng = coords[0][0], maxLat = coords[0][1];
                coords.forEach(([lng, lat]) => {
                    if (lng < minLng) minLng = lng;
                    if (lng > maxLng) maxLng = lng;
                    if (lat < minLat) minLat = lat;
                    if (lat > maxLat) maxLat = lat;
                });
                map.fitBounds([[minLng, minLat], [maxLng, maxLat]], {padding: 40});
            }
        }

        // Listen for HTMX swaps in #results-container
        document.body.addEventListener('htmx:afterSwap', function(event) {
            const elt = event.detail.elt;

            if (elt && elt.id === 'results-container') {
                const container = elt;
                console.log('afterSwap container html', container.innerHTML.substring(0, 200));

                // Find results and data elements directly in container
                const resultsContent = container.querySelector('[data-target="results"]');
                const dataHolder = container.querySelector('[data-geojson]');

                if (resultsContent) {
                    // Only populate the appropriate container based on screen size
                    const isMobile = window.innerWidth <= 768;
                    if (isMobile) {
                        document.getElementById('results-mobile').innerHTML = resultsContent.innerHTML;
                    } else {
                        document.getElementById('results-desktop').innerHTML = resultsContent.innerHTML;
                    }
                }

                if (dataHolder) {
                    const geojsonStr = dataHolder.getAttribute('data-geojson');
                    if (geojsonStr) {
                        updateMap(geojsonStr);
                    }

                    // Extract and store response data
                    const responseStr = dataHolder.getAttribute('data-response');
                    if (responseStr) {
                        currentResponse = JSON.parse(responseStr);
                        renderApiResults();
                    }
                }
            }
        });

        // Format timestamp for display
        function formatTimestamp(ts) {
            if (!ts) return '';
            try {
                const date = new Date(ts);
                if (isNaN(date.getTime())) return '';
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            } catch (e) {
                return '';
            }
        }

        function formatApiData(apiName, data) {
            if (!data) return '';

            switch (apiName) {
                case 'KNMI Weather':
                    const windDir = data.windDirection || 0;
                    const windDirName = ['N','NE','E','SE','S','SW','W','NW'][Math.round(windDir / 45) % 8] || '';
                    const weatherTs = formatTimestamp(data.lastUpdated);
                    const forecast = data.rainfallForecast || [];
                    const forecastSum = forecast.reduce((a, b) => a + b, 0);
                    return `<div class="metric-display">
                        <div class="metric-value">${data.temperature || 0}¬∞C</div>
                        <div class="metric-label">Temperature${weatherTs ? ` <span class="timestamp">(${weatherTs})</span>` : ''}</div>
                        <div class="metric-secondary">
                            üí® <strong>${data.windSpeed || 0}</strong> km/h ${windDirName} &nbsp;|&nbsp;
                            üíß <strong>${data.humidity || 0}</strong>%
                        </div>
                        <div class="metric-secondary">
                            üåßÔ∏è Now: <strong>${data.precipitation || 0}</strong> mm &nbsp;|&nbsp;
                            ‚è≥ 6h: <strong>${forecastSum.toFixed(1)}</strong> mm
                        </div>
                        ${data.pressure ? `<div class="metric-secondary">üìä Pressure: <strong>${data.pressure.toFixed(0)}</strong> hPa</div>` : ''}
                    </div>`;

                case 'KNMI Solar':
                    const peakHours = data.sunshineHours || 0;
                    const radiation = data.solarRadiation || 0;
                    const uv = data.uvIndex || 0;
                    const uvClass = uv <= 2 ? 'good' : uv <= 5 ? 'moderate' : 'poor';
                    return `<div class="metric-display">
                        <div class="metric-value">${radiation.toFixed(0)} <span style="font-size: 1rem; font-weight: 500;">W/m¬≤</span></div>
                        <div class="metric-label">Solar Radiation</div>
                        <div class="metric-secondary">
                            ‚òÄÔ∏è Sunshine: <strong>${peakHours.toFixed(1)}</strong>h today &nbsp;|&nbsp;
                            üï∂Ô∏è UV: <span class="status-badge ${uvClass}">${uv.toFixed(1)}</span>
                        </div>
                        <div class="metric-secondary">
                            ‚ö° Est. yield: <strong>${(radiation * 0.15 * peakHours / 1000).toFixed(2)}</strong> kWh/m¬≤/day
                        </div>
                    </div>`;

                case 'Luchtmeetnet Air Quality':
                    const aqi = data.aqi || 0;
                    const category = data.category || 'Unknown';
                    const aqiBadgeClass = category === 'Good' ? 'good' : category === 'Moderate' ? 'moderate' : 'poor';
                    const aqiTs = formatTimestamp(data.lastUpdated);
                    const stationName = data.stationName || '';
                    const measurements = data.measurements || [];

                    // Get key pollutants
                    const pm25 = measurements.find(m => m.parameter === 'PM25' || m.parameter === 'pm25');
                    const pm10 = measurements.find(m => m.parameter === 'PM10' || m.parameter === 'pm10');
                    const no2 = measurements.find(m => m.parameter === 'NO2' || m.parameter === 'no2');
                    const o3 = measurements.find(m => m.parameter === 'O3' || m.parameter === 'o3');

                    return `<div class="metric-display">
                        <div class="metric-value">${aqi}</div>
                        <div class="metric-label">Air Quality Index${aqiTs ? ` <span class="timestamp">(${aqiTs})</span>` : ''}</div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${aqiBadgeClass}">${category}</span>
                        </div>
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${pm25 ? `PM2.5: <strong>${pm25.value.toFixed(1)}</strong>` : ''}
                            ${pm10 ? ` &nbsp;|&nbsp; PM10: <strong>${pm10.value.toFixed(1)}</strong>` : ''}
                            ${no2 ? ` &nbsp;|&nbsp; NO‚ÇÇ: <strong>${no2.value.toFixed(1)}</strong>` : ''}
                        </div>
                        ${o3 ? `<div class="metric-secondary">O‚ÇÉ: <strong>${o3.value.toFixed(1)}</strong> ${o3.unit || '¬µg/m¬≥'}</div>` : ''}
                        ${stationName ? `<div class="metric-secondary">üìç Station: ${stationName}</div>` : ''}
                    </div>`;

                case 'CBS Population':
                    // Handle both field names: totalPopulation (from API) and population (legacy)
                    const pop = data.totalPopulation || data.population || 0;
                    const households = data.households || 0;
                    const avgHouseholdSize = data.averageHouseholdSize || 0;
                    const ageDist = data.ageDistribution || data.demographics || {};
                    const demog = data.demographics || {};
                    const popNeighbourhood = data.neighbourhoodName || '';
                    const popMunicipality = data.municipalityName || '';
                    const popDensity = data.populationDensity || 0;

                    // Build location string
                    const popLocationStr = popNeighbourhood && popMunicipality
                        ? `${popNeighbourhood}, ${popMunicipality}`
                        : popNeighbourhood || popMunicipality || '';

                    return `<div class="metric-display">
                        <div class="metric-value">${pop.toLocaleString()}</div>
                        <div class="metric-label">Residents ${popNeighbourhood ? `in ${popNeighbourhood}` : 'in Neighbourhood'}</div>
                        ${popLocationStr ? `<div class="metric-secondary">
                            üìç <strong>${popLocationStr}</strong> (CBS Buurt)
                        </div>` : ''}
                        <div class="metric-secondary"${popLocationStr ? ' style="margin-top: 0.25rem;"' : ''}>
                            üè† <strong>${households.toLocaleString()}</strong> households
                            ${avgHouseholdSize ? ` &nbsp;|&nbsp; üë• <strong>${avgHouseholdSize.toFixed(1)}</strong> avg/hh` : ''}
                        </div>
                        ${Object.keys(ageDist).length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üë∂ 0-14: <strong>${ageDist['0-14'] || demog.age0to14 || 0}</strong> &nbsp;|&nbsp;
                            üë® 25-44: <strong>${ageDist['25-44'] || demog.age25to44 || 0}</strong> &nbsp;|&nbsp;
                            üë¥ 65+: <strong>${ageDist['65+'] || demog.age65plus || 0}</strong>
                        </div>` : ''}
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìä Density: <strong>${popDensity > 0 ? popDensity.toLocaleString() : '~' + pop.toLocaleString()}</strong> per km¬≤
                        </div>
                        <div class="metric-secondary timestamp" style="margin-top: 0.25rem; font-size: 0.7rem;">
                            ‚ÑπÔ∏è CBS 'Buurt' = neighbourhood statistical area (variable size, not fixed grid)
                        </div>
                    </div>`;

                case 'CBS Square Statistics':
                    // API returns: gridId, population, households, averageWOZ, averageIncome, housingDensity, neighbourhoodName, municipalityName
                    const sqPop = data.population || 0;
                    const sqHouseholds = data.households || 0;
                    const sqDensity = data.housingDensity || 0;
                    const sqWOZ = data.averageWOZ || 0;
                    const sqIncome = data.averageIncome || 0;
                    const sqGridId = data.gridId || '';
                    const sqNeighbourhood = data.neighbourhoodName || '';
                    const sqMunicipality = data.municipalityName || '';

                    // Build location string
                    const sqLocationStr = sqNeighbourhood && sqMunicipality
                        ? `${sqNeighbourhood}, ${sqMunicipality}`
                        : sqNeighbourhood || sqMunicipality || '';

                    return `<div class="metric-display">
                        <div class="metric-value">${sqPop.toLocaleString()}</div>
                        <div class="metric-label">Population ${sqNeighbourhood ? `in ${sqNeighbourhood}` : 'in Area'}</div>
                        ${sqLocationStr ? `<div class="metric-secondary">
                            üìç <strong>${sqLocationStr}</strong> (CBS Buurt)
                        </div>` : ''}
                        <div class="metric-secondary"${sqLocationStr ? ' style="margin-top: 0.25rem;"' : ''}>
                            üè† <strong>${sqHouseholds.toLocaleString()}</strong> households &nbsp;|&nbsp;
                            üìä <strong>${sqDensity.toLocaleString()}</strong> per km¬≤
                        </div>
                        ${sqWOZ > 0 || sqIncome > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${sqWOZ > 0 ? `üí∞ WOZ: <strong>‚Ç¨${sqWOZ.toLocaleString()}</strong>` : ''}
                            ${sqIncome > 0 ? ` &nbsp;|&nbsp; üíµ Income: <strong>‚Ç¨${sqIncome.toLocaleString()}</strong>` : ''}
                        </div>` : ''}
                        <div class="metric-secondary timestamp" style="margin-top: 0.25rem; font-size: 0.7rem;">
                            ‚ÑπÔ∏è CBS 'Buurt' = neighbourhood statistical area (variable size, not fixed grid)
                        </div>
                        ${sqGridId ? `<div class="metric-secondary" style="font-size: 0.7rem; opacity: 0.6;">Grid ref: ${sqGridId}</div>` : ''}
                    </div>`;

                case 'Green Spaces':
                    // API returns: totalGreenArea, greenPercentage, nearestPark, parkDistance, treeCanopyCover, greenSpaces[]
                    const greenSpacesArr = data.greenSpaces || [];
                    const totalGreenArea = data.totalGreenArea || 0;
                    const greenPct = data.greenPercentage || 0;
                    const treeCanopy = data.treeCanopyCover || 0;
                    const greenSpaceCount = greenSpacesArr.length;
                    const greenTypes = [...new Set(greenSpacesArr.map(s => s.type).filter(t => t))];
                    const nearestPark = data.nearestPark || '';
                    const parkDist = data.parkDistance || 0;

                    // Calculate green score
                    const greenScore = Math.min(100, Math.round(greenPct * 10 + treeCanopy * 10));

                    return `<div class="metric-display">
                        <div class="metric-value">${totalGreenArea.toLocaleString()} <span style="font-size: 1rem; font-weight: 500;">m¬≤</span></div>
                        <div class="metric-label">Green Space (500m radius)</div>
                        <div class="metric-secondary">
                            üå≥ <strong>${greenSpaceCount}</strong> areas &nbsp;|&nbsp;
                            üìä <strong>${(greenPct * 100).toFixed(1)}%</strong> coverage &nbsp;|&nbsp;
                            üèÜ Score: <strong>${greenScore}</strong>/100
                        </div>
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üå≤ Tree canopy: <strong>${(treeCanopy * 100).toFixed(1)}%</strong>
                            ${nearestPark && parkDist > 0 ? ` &nbsp;|&nbsp; üìç ${nearestPark}: <strong>${Math.round(parkDist)}m</strong>` : ''}
                        </div>
                        ${greenTypes.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${greenTypes.slice(0, 4).map(t => `<span class="status-badge good" style="margin-right: 4px; font-size: 0.7rem;">${t}</span>`).join('')}
                            ${greenTypes.length > 4 ? `<span style="opacity: 0.7;">+${greenTypes.length - 4}</span>` : ''}
                        </div>` : ''}
                    </div>`;

                case 'Education Facilities':
                    // API returns: nearestPrimarySchool, nearestSecondarySchool, allSchools[], averageQuality
                    const allSchools = data.allSchools || [];
                    const nearestPrimary = data.nearestPrimarySchool;
                    const nearestSecondary = data.nearestSecondarySchool;
                    const avgQuality = data.averageQuality || 0;
                    const schoolCount = allSchools.length;
                    const schoolTypeSet = [...new Set(allSchools.map(s => s.type).filter(t => t))];
                    const primaryCount = allSchools.filter(s => s.type === 'Primary').length;
                    const secondaryCount = allSchools.filter(s => s.type === 'Secondary').length;

                    return `<div class="metric-display">
                        <div class="metric-value">${schoolCount}</div>
                        <div class="metric-label">Schools (1km radius)</div>
                        <div class="metric-secondary">
                            üè´ Primary: <strong>${primaryCount}</strong> &nbsp;|&nbsp;
                            üéì Secondary: <strong>${secondaryCount}</strong> &nbsp;|&nbsp;
                            ‚≠ê Quality: <strong>${avgQuality.toFixed(1)}</strong>/10
                        </div>
                        ${nearestPrimary ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç Nearest primary: <strong>${nearestPrimary.name}</strong> (${Math.round(nearestPrimary.distance)}m)
                        </div>` : ''}
                        ${nearestSecondary ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç Nearest secondary: <strong>${nearestSecondary.name}</strong> (${Math.round(nearestSecondary.distance)}m)
                        </div>` : ''}
                    </div>`;

                case 'Facilities & Amenities':
                    // API returns: topFacilities[], amenitiesScore, categoryCounts{}
                    const topFacilities = data.topFacilities || [];
                    const amenitiesScore = data.amenitiesScore || 0;
                    const catCounts = data.categoryCounts || {};
                    const totalFacilities = Object.values(catCounts).reduce((a, b) => a + b, 0) || topFacilities.length;
                    const categoryNames = Object.keys(catCounts);
                    const nearestFacility = topFacilities[0];
                    const scoreClass = amenitiesScore >= 70 ? 'good' : amenitiesScore >= 40 ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value">${totalFacilities}</div>
                        <div class="metric-label">Amenities (500m radius)</div>
                        <div class="metric-secondary">
                            üèÜ Score: <span class="status-badge ${scoreClass}">${amenitiesScore.toFixed(0)}/100</span>
                        </div>
                        ${categoryNames.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${categoryNames.slice(0, 5).map(c => `${c}: <strong>${catCounts[c]}</strong>`).join(' &nbsp;|&nbsp; ')}
                        </div>` : ''}
                        ${nearestFacility ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç Nearest: <strong>${nearestFacility.name}</strong> (${nearestFacility.type}, ${Math.round(nearestFacility.distance)}m)
                        </div>` : ''}
                        ${topFacilities.length > 1 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${topFacilities.slice(1, 4).map(f => `‚Ä¢ ${f.name} (${Math.round(f.distance)}m)`).join(' ')}
                        </div>` : ''}
                    </div>`;

                case 'openOV Public Transport':
                    // API returns: nearestStops[], connections[]
                    const nearestStops = data.nearestStops || [];
                    const stopCount = nearestStops.length;
                    const nearestStop = nearestStops[0];
                    const trainStops = nearestStops.filter(s => s.type === 'Train' || s.type === 'train');
                    const tramStops = nearestStops.filter(s => s.type === 'Tram' || s.type === 'tram');
                    const metroStops = nearestStops.filter(s => s.type === 'Metro' || s.type === 'metro');
                    const busStops = nearestStops.filter(s => s.type === 'Bus' || s.type === 'bus');

                    // Calculate transit score
                    const transitScore = Math.min(100, trainStops.length * 20 + metroStops.length * 15 + tramStops.length * 10 + busStops.length * 5);
                    const transitClass = transitScore >= 60 ? 'good' : transitScore >= 30 ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value">${stopCount}</div>
                        <div class="metric-label">PT Stops (500m radius)</div>
                        <div class="metric-secondary">
                            ${trainStops.length > 0 ? `üöÜ <strong>${trainStops.length}</strong> train` : ''}
                            ${metroStops.length > 0 ? ` &nbsp;|&nbsp; üöá <strong>${metroStops.length}</strong> metro` : ''}
                            ${tramStops.length > 0 ? ` &nbsp;|&nbsp; üöä <strong>${tramStops.length}</strong> tram` : ''}
                            ${busStops.length > 0 ? ` &nbsp;|&nbsp; üöå <strong>${busStops.length}</strong> bus` : ''}
                        </div>
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üèÜ Transit score: <span class="status-badge ${transitClass}">${transitScore}/100</span>
                        </div>
                        ${nearestStop ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç Nearest: <strong>${nearestStop.name}</strong> (${nearestStop.type}, ${Math.round(nearestStop.distance)}m)
                        </div>` : ''}
                        ${nearestStops.length > 1 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${nearestStops.slice(1, 4).map(s => `‚Ä¢ ${s.name} (${Math.round(s.distance)}m)`).join(' ')}
                        </div>` : ''}
                    </div>`;

                case 'AHN Height Model':
                    const elevation = data.elevation || data.height || data.hoogte || 0;
                    const elevClass = elevation < 0 ? 'poor' : elevation < 2 ? 'moderate' : 'good';
                    const floodNote = elevation < 0 ? '‚ö†Ô∏è Below sea level' : elevation < 2 ? '‚ö†Ô∏è Low-lying area' : '‚úì Elevated';
                    return `<div class="metric-display">
                        <div class="metric-value">${elevation.toFixed(2)} <span style="font-size: 1rem; font-weight: 500;">m NAP</span></div>
                        <div class="metric-label">Ground Elevation</div>
                        <div class="metric-secondary">
                            <span class="status-badge ${elevClass}">${floodNote}</span>
                        </div>
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç Relative to Amsterdam Ordnance Datum (NAP)
                        </div>
                        ${elevation < 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üíß <strong>${Math.abs(elevation).toFixed(2)}m</strong> below sea level
                        </div>` : ''}
                    </div>`;

                case 'Noise Pollution':
                    // API returns: totalNoise, roadNoise, railNoise, industryNoise, aircraftNoise, noiseCategory, exceedsLimit
                    const totalNoise = data.totalNoise || 0;
                    const noiseCategory = data.noiseCategory || 'Unknown';
                    const noiseBadge = noiseCategory === 'Quiet' ? 'good' : noiseCategory === 'Moderate' ? 'moderate' : noiseCategory === 'Unknown' ? 'moderate' : 'poor';
                    const noiseSources = [];
                    if (data.roadNoise > 0) noiseSources.push({ type: 'üöó Road', value: data.roadNoise });
                    if (data.railNoise > 0) noiseSources.push({ type: 'üöÇ Rail', value: data.railNoise });
                    if (data.aircraftNoise > 0) noiseSources.push({ type: '‚úàÔ∏è Air', value: data.aircraftNoise });
                    if (data.industryNoise > 0) noiseSources.push({ type: 'üè≠ Industry', value: data.industryNoise });

                    // Calculate health impact indicator
                    const healthImpact = totalNoise > 65 ? 'High risk' : totalNoise > 55 ? 'Moderate risk' : 'Low risk';
                    const healthClass = totalNoise > 65 ? 'poor' : totalNoise > 55 ? 'moderate' : 'good';

                    return `<div class="metric-display">
                        <div class="metric-value">${totalNoise} <span style="font-size: 1rem; font-weight: 500;">dB(A)</span></div>
                        <div class="metric-label">Total Noise Level (Lden)</div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${noiseBadge}">${noiseCategory}</span>
                            ${data.exceedsLimit ? '<span class="status-badge poor" style="margin-left: 4px;">‚ö†Ô∏è Exceeds 55dB</span>' : ''}
                        </div>
                        ${noiseSources.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${noiseSources.map(s => `${s.type}: <strong>${s.value}</strong>dB`).join(' &nbsp;|&nbsp; ')}
                        </div>` : ''}
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üè• Health: <span class="status-badge ${healthClass}">${healthImpact}</span>
                        </div>
                    </div>`;

                case 'Parking Availability':
                    // API returns: totalSpaces, availableSpaces, occupancyRate, parkingZones[], lastUpdated
                    const totalSpaces = data.totalSpaces || 0;
                    const availableSpaces = data.availableSpaces || 0;
                    const occupancyRate = data.occupancyRate || 0;
                    const parkingZones = data.parkingZones || [];
                    const parkingBadge = occupancyRate < 50 ? 'good' : occupancyRate < 80 ? 'moderate' : 'poor';
                    const parkingTs = formatTimestamp(data.lastUpdated);

                    // Get zone types
                    const zoneTypes = [...new Set(parkingZones.map(z => z.type).filter(t => t))];

                    return `<div class="metric-display">
                        <div class="metric-value">${totalSpaces > 0 ? availableSpaces : '--'}</div>
                        <div class="metric-label">Available Spaces${parkingTs ? ` <span class="timestamp">(${parkingTs})</span>` : ''}</div>
                        ${totalSpaces > 0 ? `<div class="metric-secondary">
                            üÖøÔ∏è <strong>${totalSpaces}</strong> total &nbsp;|&nbsp;
                            <span class="status-badge ${parkingBadge}">${occupancyRate.toFixed(0)}% full</span>
                        </div>` : '<div class="metric-secondary">üÖøÔ∏è No real-time parking data</div>'}
                        ${parkingZones.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç <strong>${parkingZones.length}</strong> parking zones nearby
                            ${zoneTypes.length > 0 ? ` (${zoneTypes.join(', ')})` : ''}
                        </div>` : ''}
                        ${totalSpaces > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìä Avg wait: <strong>${occupancyRate > 80 ? '10-15' : occupancyRate > 50 ? '5-10' : '< 5'}</strong> min
                        </div>` : ''}
                    </div>`;

                case 'Building Permits':
                    // API returns: totalPermits, newConstruction, renovations, permits[], growthTrend
                    const totalPermits = data.totalPermits || 0;
                    const newConstruction = data.newConstruction || 0;
                    const renovations = data.renovations || 0;
                    const growthTrend = data.growthTrend || 'Unknown';
                    const permits = data.permits || [];
                    const trendBadge = growthTrend === 'Increasing' ? 'good' : growthTrend === 'Stable' ? 'moderate' : growthTrend === 'Unknown' ? 'moderate' : 'poor';

                    // Recent permit details
                    const recentPermit = permits[0];
                    const permitTypes = [...new Set(permits.map(p => p.type).filter(t => t))];

                    // Development activity indicator
                    const activityLevel = totalPermits > 10 ? 'High' : totalPermits > 3 ? 'Moderate' : 'Low';

                    return `<div class="metric-display">
                        <div class="metric-value">${totalPermits}</div>
                        <div class="metric-label">Building Permits (2yr, 500m)</div>
                        <div class="metric-secondary">
                            üèóÔ∏è New builds: <strong>${newConstruction}</strong> &nbsp;|&nbsp;
                            üîß Renovations: <strong>${renovations}</strong>
                        </div>
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìà Trend: <span class="status-badge ${trendBadge}">${growthTrend}</span> &nbsp;|&nbsp;
                            Activity: <strong>${activityLevel}</strong>
                        </div>
                        ${permitTypes.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            Types: ${permitTypes.slice(0, 3).join(', ')}${permitTypes.length > 3 ? ` +${permitTypes.length - 3}` : ''}
                        </div>` : ''}
                        ${recentPermit ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìã Latest: <strong>${recentPermit.type || 'Permit'}</strong> ${recentPermit.date ? `(${recentPermit.date})` : ''}
                        </div>` : ''}
                    </div>`;

                case 'CBS StatLine':
                    // API returns: regionCode, regionName, population, averageIncome, employmentRate, educationLevel, housingStock, averageWOZ, year
                    const slRegionName = data.regionName || 'Unknown';
                    const slRegionCode = data.regionCode || '';
                    const slPopulation = data.population || 0;
                    const slAvgIncome = data.averageIncome || 0;
                    const slEmploymentRate = data.employmentRate || 0;
                    const slEducationLevel = data.educationLevel || 'Unknown';
                    const slAvgWOZ = data.averageWOZ || 0;
                    const slHousingStock = data.housingStock || 0;
                    const slYear = data.year || 2024;

                    // Employment indicator
                    const empClass = slEmploymentRate >= 70 ? 'good' : slEmploymentRate >= 50 ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.5rem;">‚Ç¨${slAvgIncome > 0 ? slAvgIncome.toLocaleString() : '--'}</div>
                        <div class="metric-label">Avg Household Income <span class="timestamp">(${slYear})</span></div>
                        <div class="metric-secondary">
                            üë• Pop: <strong>${slPopulation.toLocaleString()}</strong> &nbsp;|&nbsp;
                            üè† Stock: <strong>${slHousingStock.toLocaleString()}</strong>
                        </div>
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üíº Employment: <span class="status-badge ${empClass}">${slEmploymentRate.toFixed(1)}%</span>
                            ${slEducationLevel !== 'Unknown' ? ` &nbsp;|&nbsp; üéì <strong>${slEducationLevel}</strong>` : ''}
                        </div>
                        ${slAvgWOZ > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üí∞ Avg WOZ: <strong>‚Ç¨${slAvgWOZ.toLocaleString()}</strong>
                            ${slAvgIncome > 0 && slAvgWOZ > 0 ? ` &nbsp;|&nbsp; Ratio: <strong>${(slAvgWOZ / slAvgIncome).toFixed(1)}x</strong> income` : ''}
                        </div>` : ''}
                        ${slRegionCode ? `<div class="metric-secondary" style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">Region: ${slRegionName} (${slRegionCode})</div>` : ''}
                    </div>`;

                case 'Altum Energy & Climate':
                    // API returns: energyLabel, climateRisk, efficiencyScore, annualEnergyCost, co2Emissions, heatLoss
                    const energyLabel = data.energyLabel || 'Unknown';
                    const climateRisk = data.climateRisk || 'Unknown';
                    const efficiencyScore = data.efficiencyScore || 0;
                    const annualEnergyCost = data.annualEnergyCost || 0;
                    const co2Emissions = data.co2Emissions || 0;
                    const heatLoss = data.heatLoss || 0;
                    const labelClass = ['A++++', 'A+++', 'A++', 'A+', 'A', 'B'].includes(energyLabel) ? 'good' : ['C', 'D'].includes(energyLabel) ? 'moderate' : 'poor';
                    const riskClass = climateRisk === 'Low' ? 'good' : climateRisk === 'Medium' ? 'moderate' : climateRisk === 'Unknown' ? 'moderate' : 'poor';

                    // Monthly cost estimate
                    const monthlyCost = annualEnergyCost > 0 ? Math.round(annualEnergyCost / 12) : 0;

                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${labelClass}" style="font-size: 1.1rem; padding: 8px 16px;">‚ö° ${energyLabel}</span>
                            ${efficiencyScore > 0 ? `<span style="margin-left: 8px; opacity: 0.8;">Score: ${efficiencyScore}/100</span>` : ''}
                        </div>
                        <div class="metric-label">Energy Label</div>
                        <div class="metric-secondary" style="margin-top: 0.5rem;">
                            üå°Ô∏è Climate Risk: <span class="status-badge ${riskClass}">${climateRisk}</span>
                        </div>
                        ${annualEnergyCost > 0 || co2Emissions > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${annualEnergyCost > 0 ? `üí∂ <strong>‚Ç¨${monthlyCost}</strong>/mo (‚Ç¨${annualEnergyCost.toLocaleString()}/yr)` : ''}
                            ${co2Emissions > 0 ? ` &nbsp;|&nbsp; üåç <strong>${co2Emissions.toLocaleString()}</strong> kg CO‚ÇÇ/yr` : ''}
                        </div>` : ''}
                        ${heatLoss > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üî• Heat loss: <strong>${heatLoss}</strong> W/m¬≤K
                        </div>` : ''}
                    </div>`;

                case 'Altum Sustainability':
                    // API returns: currentRating, potentialRating, recommendedMeasures[], totalCO2Savings, totalCostSavings, investmentCost, paybackPeriod
                    const currentRating = data.currentRating || 'Unknown';
                    const potentialRating = data.potentialRating || 'Unknown';
                    const measures = data.recommendedMeasures || [];
                    const totalCO2Savings = data.totalCO2Savings || 0;
                    const totalCostSavings = data.totalCostSavings || 0;
                    const investmentCost = data.investmentCost || 0;
                    const paybackPeriod = data.paybackPeriod || 0;

                    // Rating improvement class
                    const improvable = currentRating !== potentialRating && potentialRating !== 'Unknown';

                    // ROI calculation
                    const roi = investmentCost > 0 && totalCostSavings > 0 ? ((totalCostSavings / investmentCost) * 100).toFixed(0) : 0;

                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.25rem;">${currentRating} ${improvable ? `‚Üí <span style="color: var(--success);">${potentialRating}</span>` : ''}</div>
                        <div class="metric-label">Sustainability Rating</div>
                        ${totalCostSavings > 0 || totalCO2Savings > 0 ? `<div class="metric-secondary">
                            ${totalCostSavings > 0 ? `üí∞ Save <strong>‚Ç¨${totalCostSavings.toLocaleString()}</strong>/yr` : ''}
                            ${totalCO2Savings > 0 ? ` &nbsp;|&nbsp; üå± <strong>${totalCO2Savings.toLocaleString()}</strong> kg CO‚ÇÇ` : ''}
                        </div>` : ''}
                        ${investmentCost > 0 || paybackPeriod > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${investmentCost > 0 ? `üíµ Investment: <strong>‚Ç¨${investmentCost.toLocaleString()}</strong>` : ''}
                            ${paybackPeriod > 0 ? ` &nbsp;|&nbsp; ‚è±Ô∏è Payback: <strong>${paybackPeriod.toFixed(1)}</strong>yr` : ''}
                            ${roi > 0 ? ` &nbsp;|&nbsp; üìà ROI: <strong>${roi}%</strong>/yr` : ''}
                        </div>` : ''}
                        ${measures.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìã <strong>${measures.length}</strong> measures: ${measures.slice(0, 2).map(m => m.name || m).join(', ')}${measures.length > 2 ? '...' : ''}
                        </div>` : ''}
                    </div>`;

                case 'Flood Risk':
                    const riskLevel = data.riskLevel || 'Unknown';
                    const floodBadgeClass = riskLevel === 'Low' ? 'good' : riskLevel === 'Medium' ? 'moderate' : 'poor';
                    const zoneName = data.zoneName || '';
                    const returnPeriod = data.returnPeriod || 0;
                    const maxDepth = data.maxDepth || 0;
                    const protectionLevel = data.protectionLevel || '';

                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${floodBadgeClass}" style="font-size: 0.9rem; padding: 6px 14px;">üåä ${riskLevel} Risk</span>
                        </div>
                        <div class="metric-label">Flood Risk Assessment</div>
                        ${zoneName ? `<div class="metric-secondary">Zone: <strong>${zoneName}</strong></div>` : ''}
                        ${returnPeriod > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìä Return period: <strong>1 in ${returnPeriod}</strong> years
                        </div>` : ''}
                        ${maxDepth > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üíß Max depth: <strong>${maxDepth.toFixed(1)}</strong>m in event
                        </div>` : ''}
                        ${protectionLevel ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üõ°Ô∏è Protection: <strong>${protectionLevel}</strong>
                        </div>` : ''}
                    </div>`;

                case 'NDW Traffic':
                    // Handle both array and object data
                    const trafficData = Array.isArray(data) ? data : [data];
                    const totalIncidents = trafficData.reduce((sum, t) => sum + (t.incidentCount || 0), 0);
                    const avgSpeed = trafficData.length > 0 ? trafficData.reduce((sum, t) => sum + (t.averageSpeed || 0), 0) / trafficData.length : 0;
                    const measurementPoints = trafficData.length;
                    const congestionLevel = avgSpeed < 30 ? 'High' : avgSpeed < 50 ? 'Moderate' : 'Low';
                    const congestionClass = avgSpeed < 30 ? 'poor' : avgSpeed < 50 ? 'moderate' : 'good';

                    return `<div class="metric-display">
                        <div class="metric-value">${avgSpeed > 0 ? avgSpeed.toFixed(0) : '--'} <span style="font-size: 1rem; font-weight: 500;">km/h</span></div>
                        <div class="metric-label">Average Traffic Speed</div>
                        <div class="metric-secondary">
                            üöó Congestion: <span class="status-badge ${congestionClass}">${congestionLevel}</span>
                            &nbsp;|&nbsp; ‚ö†Ô∏è <strong>${totalIncidents}</strong> incidents
                        </div>
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç <strong>${measurementPoints}</strong> measurement points nearby
                        </div>
                    </div>`;

                case 'WUR Soil Physicals':
                    const soilType = data.soilType || 'Unknown';
                    const soilPh = data.ph || data.pH || 0;
                    const organicMatter = data.organicMatter || 0;
                    const waterRetention = data.waterRetention || 0;
                    const drainage = data.drainage || 'Unknown';

                    // Soil quality indicator
                    const soilQualityScore = organicMatter > 5 ? 'Good' : organicMatter > 2 ? 'Moderate' : 'Poor';
                    const soilQualityClass = organicMatter > 5 ? 'good' : organicMatter > 2 ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.25rem;">${soilType}</div>
                        <div class="metric-label">Soil Type Classification</div>
                        <div class="metric-secondary">
                            üß™ pH: <strong>${soilPh || 'N/A'}</strong> &nbsp;|&nbsp;
                            üå± Organic: <strong>${organicMatter || 'N/A'}</strong>%
                        </div>
                        ${waterRetention > 0 || drainage !== 'Unknown' ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${waterRetention > 0 ? `üíß Retention: <strong>${waterRetention}</strong>%` : ''}
                            ${drainage !== 'Unknown' ? ` &nbsp;|&nbsp; üö∞ Drainage: <strong>${drainage}</strong>` : ''}
                        </div>` : ''}
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üèÜ Fertility: <span class="status-badge ${soilQualityClass}">${soilQualityScore}</span>
                        </div>
                    </div>`;

                case 'BRO Soil Map':
                    const broSoilType = data.soilType || data.description || 'Data available';
                    const broCode = data.soilCode || '';
                    const broDepth = data.depth || 0;
                    const broGroundwater = data.groundwaterClass || '';

                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.1rem;">${broSoilType}</div>
                        <div class="metric-label">BRO Soil Classification</div>
                        ${broCode ? `<div class="metric-secondary">Code: <strong>${broCode}</strong></div>` : ''}
                        ${broDepth > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìè Survey depth: <strong>${broDepth}</strong>m
                        </div>` : ''}
                        ${broGroundwater ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üíß Groundwater: <strong>${broGroundwater}</strong>
                        </div>` : ''}
                    </div>`;

                case 'SkyGeo Subsidence':
                    const subsidenceRate = data.subsidenceRate || 0;
                    const subsidenceClass = subsidenceRate > 5 ? 'poor' : subsidenceRate > 2 ? 'moderate' : 'good';
                    const subsidenceRiskLevel = subsidenceRate > 5 ? 'High' : subsidenceRate > 2 ? 'Medium' : 'Low';
                    const measurementPeriod = data.measurementPeriod || '';
                    const confidence = data.confidence || 0;
                    const totalSubsidence = data.totalSubsidence || 0;

                    // Calculate impact
                    const structuralRisk = subsidenceRate > 5 ? 'Foundation monitoring recommended' : subsidenceRate > 2 ? 'Monitor periodically' : 'No action needed';

                    return `<div class="metric-display">
                        <div class="metric-value">${subsidenceRate.toFixed(1)} <span style="font-size: 1rem; font-weight: 500;">mm/yr</span></div>
                        <div class="metric-label">Ground Subsidence Rate</div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${subsidenceClass}">${subsidenceRiskLevel} Risk</span>
                        </div>
                        ${totalSubsidence > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìâ Total: <strong>${totalSubsidence.toFixed(0)}</strong>mm over ${measurementPeriod || 'measurement period'}
                        </div>` : ''}
                        ${confidence > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìä Confidence: <strong>${confidence}%</strong>
                        </div>` : ''}
                        <div class="metric-secondary" style="margin-top: 0.25rem; font-size: 0.8rem; opacity: 0.8;">
                            üí° ${structuralRisk}
                        </div>
                    </div>`;

                case 'Monument Status':
                    const hasStatus = data.status && data.status !== 'Not protected';
                    const monumentType = data.type || '';
                    const monumentDescription = data.description || '';
                    const registrationDate = data.registrationDate || '';
                    const monumentNumber = data.monumentNumber || '';

                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${hasStatus ? 'moderate' : 'good'}">${data.status || 'Not Protected'}</span>
                            ${monumentType ? `<span class="status-badge" style="margin-left: 4px; background: var(--bg-tertiary);">${monumentType}</span>` : ''}
                        </div>
                        <div class="metric-label">Heritage Protection Status</div>
                        ${monumentDescription ? `<div class="metric-secondary">${monumentDescription}</div>` : ''}
                        ${monumentNumber ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìã Register #: <strong>${monumentNumber}</strong>
                        </div>` : ''}
                        ${registrationDate ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìÖ Registered: <strong>${registrationDate}</strong>
                        </div>` : ''}
                        ${hasStatus ? `<div class="metric-secondary" style="margin-top: 0.25rem; font-size: 0.8rem; opacity: 0.8;">
                            ‚ö†Ô∏è Renovation requires heritage permit
                        </div>` : ''}
                    </div>`;

                case 'BAG Address':
                    const bagAddress = data.address || 'Address verified';
                    const bagCoords = data.coordinates || [];
                    const bagMunicipality = data.municipality || '';
                    const bagProvince = data.province || '';
                    const bagId = data.id || data.verblijfsobjectId || '';
                    const pandId = data.pandId || '';

                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1rem; font-weight: 600;">${bagAddress}</div>
                        <div class="metric-label">Official BAG Registration</div>
                        ${bagMunicipality || bagProvince ? `<div class="metric-secondary">
                            üìç ${bagMunicipality}${bagProvince ? `, ${bagProvince}` : ''}
                        </div>` : ''}
                        ${bagCoords.length >= 2 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üåê ${bagCoords[1]?.toFixed(6)}, ${bagCoords[0]?.toFixed(6)}
                        </div>` : ''}
                        ${bagId ? `<div class="metric-secondary" style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">
                            BAG ID: ${bagId}${pandId ? ` | Pand: ${pandId}` : ''}
                        </div>` : ''}
                    </div>`;

                case 'PDOK Platform':
                    const pdokZoning = data.zoningInfo || 'Data Available';
                    const pdokRestrictions = data.restrictions || [];
                    const pdokPlanType = data.planType || '';
                    const pdokPlanStatus = data.planStatus || '';

                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1rem;">${pdokZoning}</div>
                        <div class="metric-label">Zoning Information</div>
                        ${pdokPlanType || pdokPlanStatus ? `<div class="metric-secondary">
                            ${pdokPlanType ? `üìã Type: <strong>${pdokPlanType}</strong>` : ''}
                            ${pdokPlanStatus ? ` &nbsp;|&nbsp; üìä Status: <strong>${pdokPlanStatus}</strong>` : ''}
                        </div>` : ''}
                        ${pdokRestrictions.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ‚ö†Ô∏è <strong>${pdokRestrictions.length}</strong> restriction${pdokRestrictions.length > 1 ? 's' : ''}: ${pdokRestrictions.slice(0, 2).join(', ')}${pdokRestrictions.length > 2 ? '...' : ''}
                        </div>` : ''}
                    </div>`;

                case 'Land Use & Zoning':
                    const primaryUse = data.primaryUse || data.landUseType || 'Unknown';
                    const zoningCode = data.zoningCode || '';
                    const zoningDetails = data.zoningDetails || '';
                    const allowedUses = data.allowedUses || [];
                    const maxHeight = data.maxBuildingHeight || 0;
                    const maxCoverage = data.maxCoverage || 0;

                    return `<div class="metric-display">
                        <div class="metric-value" style="font-size: 1.1rem;">${primaryUse}</div>
                        <div class="metric-label">Land Use Classification</div>
                        ${zoningCode ? `<div class="metric-secondary">Zone: <strong>${zoningCode}</strong></div>` : ''}
                        ${zoningDetails ? `<div class="metric-secondary" style="margin-top: 0.25rem;">${zoningDetails}</div>` : ''}
                        ${maxHeight > 0 || maxCoverage > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${maxHeight > 0 ? `üìè Max height: <strong>${maxHeight}m</strong>` : ''}
                            ${maxCoverage > 0 ? ` &nbsp;|&nbsp; üìê Max coverage: <strong>${maxCoverage}%</strong>` : ''}
                        </div>` : ''}
                        ${allowedUses.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ‚úì Allowed: ${allowedUses.slice(0, 3).join(', ')}${allowedUses.length > 3 ? '...' : ''}
                        </div>` : ''}
                    </div>`;

                case 'Altum WOZ':
                    // API returns: wozValue, valueYear, buildingType, buildYear, surfaceArea
                    const wozValue = data.wozValue || 0;
                    const valueYear = data.valueYear || '';
                    const wozBuildingType = data.buildingType || 'Unknown';
                    const wozBuildYear = data.buildYear || 0;
                    const wozSurfaceArea = data.surfaceArea || 0;
                    const wozPerSqm = wozValue > 0 && wozSurfaceArea > 0 ? Math.round(wozValue / wozSurfaceArea) : 0;
                    const buildingAge = wozBuildYear > 0 ? new Date().getFullYear() - wozBuildYear : 0;

                    return `<div class="metric-display">
                        <div class="metric-value">‚Ç¨${wozValue.toLocaleString()}</div>
                        <div class="metric-label">WOZ Tax Value${valueYear ? ` <span class="timestamp">(${valueYear})</span>` : ''}</div>
                        <div class="metric-secondary">
                            üè† <strong>${wozBuildingType}</strong>
                            ${wozBuildYear > 0 ? ` &nbsp;|&nbsp; üìÖ <strong>${wozBuildYear}</strong> (${buildingAge}yr old)` : ''}
                        </div>
                        ${wozSurfaceArea > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìê Surface: <strong>${wozSurfaceArea}m¬≤</strong>
                            ${wozPerSqm > 0 ? ` &nbsp;|&nbsp; üí∞ <strong>‚Ç¨${wozPerSqm.toLocaleString()}</strong>/m¬≤` : ''}
                        </div>` : ''}
                    </div>`;

                case 'Altum Transactions':
                    // API returns: transactions[], totalCount
                    const transactions = data.transactions || [];
                    const txCount = data.totalCount || transactions.length;
                    const latestTx = transactions[0];
                    const oldestTx = transactions[transactions.length - 1];

                    // Price appreciation calculation
                    let appreciation = 0;
                    if (transactions.length >= 2 && latestTx?.purchasePrice > 0 && oldestTx?.purchasePrice > 0) {
                        appreciation = ((latestTx.purchasePrice - oldestTx.purchasePrice) / oldestTx.purchasePrice * 100);
                    }

                    return `<div class="metric-display">
                        <div class="metric-value">${txCount}</div>
                        <div class="metric-label">Transaction History</div>
                        ${latestTx ? `<div class="metric-secondary">
                            üí∞ Last: <strong>‚Ç¨${(latestTx.purchasePrice || 0).toLocaleString()}</strong>
                            ${latestTx.date ? ` <span class="timestamp">(${latestTx.date})</span>` : ''}
                        </div>` : '<div class="metric-secondary">No transaction history</div>'}
                        ${latestTx && latestTx.surfaceArea ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìê <strong>${latestTx.surfaceArea}m¬≤</strong> &nbsp;|&nbsp;
                            ‚Ç¨${Math.round((latestTx.purchasePrice || 0) / latestTx.surfaceArea).toLocaleString()}/m¬≤
                        </div>` : ''}
                        ${appreciation !== 0 && transactions.length >= 2 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìà ${appreciation > 0 ? '+' : ''}${appreciation.toFixed(1)}% since ${oldestTx?.date || 'first sale'}
                        </div>` : ''}
                        ${transactions.length > 1 ? `<div class="metric-secondary" style="margin-top: 0.25rem; font-size: 0.8rem; opacity: 0.8;">
                            ${transactions.slice(1, 3).map(t => `‚Ç¨${(t.purchasePrice || 0).toLocaleString()} (${t.date || 'N/A'})`).join(' ‚Üí ')}
                        </div>` : ''}
                    </div>`;

                case 'Kadaster Object Info':
                    // API returns: ownerName, cadastralReference, wozValue, energyLabel, municipalTaxes, surfaceArea, plotSize, buildingType, buildYear
                    const kdWOZ = data.wozValue || 0;
                    const kdEnergyLabel = data.energyLabel || 'Unknown';
                    const kdSurface = data.surfaceArea || 0;
                    const kdPlot = data.plotSize || 0;
                    const kdBuildType = data.buildingType || 'Unknown';
                    const kdBuildYear = data.buildYear || 0;
                    const kdCadastralRef = data.cadastralReference || '';
                    const kdMunicipalTaxes = data.municipalTaxes || 0;
                    const kdLabelClass = ['A++++', 'A+++', 'A++', 'A+', 'A', 'B'].includes(kdEnergyLabel) ? 'good' : ['C', 'D'].includes(kdEnergyLabel) ? 'moderate' : 'poor';
                    const kdBuildingAge = kdBuildYear > 0 ? new Date().getFullYear() - kdBuildYear : 0;
                    const kdWozPerSqm = kdWOZ > 0 && kdSurface > 0 ? Math.round(kdWOZ / kdSurface) : 0;

                    return `<div class="metric-display">
                        ${kdWOZ > 0 ? `<div class="metric-value">‚Ç¨${kdWOZ.toLocaleString()}</div>
                        <div class="metric-label">Kadaster Value</div>` :
                        `<div class="metric-value" style="font-size: 1.25rem;">${kdBuildType}</div>
                        <div class="metric-label">Property Type</div>`}
                        <div class="metric-secondary" style="margin-top: 0.5rem;">
                            ‚ö° <span class="status-badge ${kdLabelClass}">${kdEnergyLabel}</span>
                            ${kdBuildYear > 0 ? ` &nbsp;|&nbsp; üìÖ <strong>${kdBuildYear}</strong> (${kdBuildingAge}yr)` : ''}
                        </div>
                        ${kdSurface > 0 || kdPlot > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${kdSurface > 0 ? `üìê Living: <strong>${kdSurface}m¬≤</strong>` : ''}
                            ${kdPlot > 0 ? ` &nbsp;|&nbsp; üè° Plot: <strong>${kdPlot}m¬≤</strong>` : ''}
                            ${kdWozPerSqm > 0 ? ` &nbsp;|&nbsp; ‚Ç¨${kdWozPerSqm.toLocaleString()}/m¬≤` : ''}
                        </div>` : ''}
                        ${kdMunicipalTaxes > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üèõÔ∏è Municipal tax: <strong>‚Ç¨${kdMunicipalTaxes.toLocaleString()}</strong>/yr
                        </div>` : ''}
                        ${kdCadastralRef ? `<div class="metric-secondary" style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">
                            Cadastral: ${kdCadastralRef}
                        </div>` : ''}
                    </div>`;

                case 'Matrixian Property Value+':
                    // API returns: marketValue, valuationDate, confidence, comparableProperties[], features, pricePerSqm
                    const marketValue = data.marketValue || 0;
                    const marketConfidence = data.confidence || 0;
                    const pricePerSqm = data.pricePerSqm || 0;
                    const comparables = data.comparableProperties || [];
                    const valuationDate = data.valuationDate || '';
                    const confidenceClass = marketConfidence >= 80 ? 'good' : marketConfidence >= 60 ? 'moderate' : 'poor';
                    const features = data.features || {};

                    // Value range based on confidence
                    const valueLow = marketValue > 0 ? Math.round(marketValue * (1 - (100 - marketConfidence) / 200)) : 0;
                    const valueHigh = marketValue > 0 ? Math.round(marketValue * (1 + (100 - marketConfidence) / 200)) : 0;

                    return `<div class="metric-display">
                        <div class="metric-value">‚Ç¨${marketValue.toLocaleString()}</div>
                        <div class="metric-label">Market Value${valuationDate ? ` <span class="timestamp">(${valuationDate})</span>` : ''}</div>
                        <div class="metric-secondary">
                            üìä Confidence: <span class="status-badge ${confidenceClass}">${marketConfidence.toFixed(0)}%</span>
                            ${pricePerSqm > 0 ? ` &nbsp;|&nbsp; ‚Ç¨${pricePerSqm.toLocaleString()}/m¬≤` : ''}
                        </div>
                        ${valueLow > 0 && valueHigh > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìâ Range: <strong>‚Ç¨${valueLow.toLocaleString()}</strong> - <strong>‚Ç¨${valueHigh.toLocaleString()}</strong>
                        </div>` : ''}
                        ${comparables.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üèòÔ∏è Based on <strong>${comparables.length}</strong> comparable sales
                            ${comparables[0]?.price ? ` (‚Ç¨${comparables[0].price.toLocaleString()} avg)` : ''}
                        </div>` : ''}
                    </div>`;

                case 'Digital Delta Water Quality':
                    // API returns: waterLevel, waterQuality, parameters, nearestWater, distance, lastMeasured
                    const waterQuality = data.waterQuality || 'Unknown';
                    const waterLevel = data.waterLevel || 0;
                    const nearestWater = data.nearestWater || '';
                    const waterDistance = data.distance || 0;
                    const waterParams = data.parameters || [];
                    const waterTs = formatTimestamp(data.lastMeasured);
                    const qualityClass = waterQuality === 'Excellent' || waterQuality === 'Good' ? 'good' : waterQuality === 'Fair' ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${qualityClass}" style="font-size: 0.9rem; padding: 6px 14px;">üíß ${waterQuality}</span>
                        </div>
                        <div class="metric-label">Water Quality${waterTs ? ` <span class="timestamp">(${waterTs})</span>` : ''}</div>
                        ${nearestWater ? `<div class="metric-secondary">
                            üìç ${nearestWater}${waterDistance > 0 ? ` (<strong>${Math.round(waterDistance)}m</strong>)` : ''}
                        </div>` : ''}
                        ${waterLevel !== 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìè Water level: <strong>${waterLevel.toFixed(2)}m</strong> NAP
                        </div>` : ''}
                        ${waterParams.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üß™ ${waterParams.slice(0, 3).map(p => `${p.name}: <strong>${p.value}</strong>${p.unit || ''}`).join(' | ')}
                        </div>` : ''}
                    </div>`;

                case 'CBS Safety Experience':
                    // API returns: safetyScore, safetyPerception, crimeRate, crimeTypes, policeResponse, yearOverYearChange
                    const safetyScore = data.safetyScore || 0;
                    const safetyPerception = data.safetyPerception || 'Unknown';
                    const crimeRate = data.crimeRate || 0;
                    const policeResponse = data.policeResponse || 0;
                    const yoyChange = data.yearOverYearChange || 0;
                    const safetyClass = safetyPerception === 'Very Safe' || safetyPerception === 'Safe' ? 'good' : safetyPerception === 'Moderate' ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value">${safetyScore.toFixed(0)}<span style="font-size: 1rem; font-weight: 500;">/100</span></div>
                        <div class="metric-label">Safety Score</div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${safetyClass}">${safetyPerception}</span>
                        </div>
                        <div class="metric-secondary" style="margin-top: 0.25rem;">
                            üöî Crime: <strong>${crimeRate.toFixed(1)}</strong>/1000 residents
                            ${policeResponse > 0 ? ` &nbsp;|&nbsp; üö® Response: <strong>${policeResponse.toFixed(0)}</strong>min` : ''}
                        </div>
                        ${yoyChange !== 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            ${yoyChange > 0 ? 'üìà' : 'üìâ'} YoY: <strong>${yoyChange > 0 ? '+' : ''}${yoyChange.toFixed(1)}%</strong>
                        </div>` : ''}
                    </div>`;

                case 'Schiphol Flight Noise':
                    // API returns: dailyFlights, noiseLevel, peakHours[], flightPaths[], nightFlights, noiseContour
                    const dailyFlights = data.dailyFlights || 0;
                    const flightNoiseLevel = data.noiseLevel || 0;
                    const nightFlights = data.nightFlights || 0;
                    const noiseContour = data.noiseContour || '';
                    const flightPaths = data.flightPaths || [];
                    const flightNoiseClass = flightNoiseLevel < 45 ? 'good' : flightNoiseLevel < 55 ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value">${flightNoiseLevel.toFixed(0)} <span style="font-size: 1rem; font-weight: 500;">dB(A)</span></div>
                        <div class="metric-label">Aviation Noise Level</div>
                        <div class="metric-secondary">
                            ‚úàÔ∏è <strong>${dailyFlights}</strong> flights/day
                            ${nightFlights > 0 ? ` &nbsp;|&nbsp; üåô <strong>${nightFlights}</strong> at night` : ''}
                        </div>
                        ${noiseContour ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üìç Noise zone: <span class="status-badge ${flightNoiseClass}">Ke ${noiseContour}</span>
                        </div>` : ''}
                        ${flightPaths.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üõ´ <strong>${flightPaths.length}</strong> flight paths nearby
                        </div>` : ''}
                    </div>`;

                case 'Soil Quality':
                    // API returns: contaminationLevel, contaminants[], qualityZone, restrictedUse, lastTested
                    const contamLevel = data.contaminationLevel || 'Unknown';
                    const contaminants = data.contaminants || [];
                    const qualityZone = data.qualityZone || '';
                    const soilLastTested = formatTimestamp(data.lastTested);
                    const restrictedUse = data.restrictedUse || false;
                    const contamClass = contamLevel === 'Clean' ? 'good' : contamLevel === 'Light' ? 'moderate' : contamLevel === 'Unknown' ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div style="margin-bottom: 0.5rem;">
                            <span class="status-badge ${contamClass}" style="font-size: 0.9rem; padding: 6px 14px;">üß™ ${contamLevel}</span>
                            ${restrictedUse ? '<span class="status-badge poor" style="margin-left: 4px;">‚ö†Ô∏è Restricted Use</span>' : ''}
                        </div>
                        <div class="metric-label">Soil Contamination${soilLastTested ? ` <span class="timestamp">(${soilLastTested})</span>` : ''}</div>
                        ${qualityZone ? `<div class="metric-secondary">üìç Zone: <strong>${qualityZone}</strong></div>` : ''}
                        ${contaminants.length > 0 ? `<div class="metric-secondary"${qualityZone ? ' style="margin-top: 0.25rem;"' : ''}>
                            Detected: ${contaminants.slice(0, 3).map(c => `<strong>${c}</strong>`).join(', ')}
                            ${contaminants.length > 3 ? ` +${contaminants.length - 3} more` : ''}
                        </div>` : '<div class="metric-secondary">No contaminants detected</div>'}
                    </div>`;

                case 'Stratopo Environment':
                    // API returns: environmentScore, totalVariables, pollutionIndex, urbanizationLevel, environmentFactors, esgRating, recommendations[]
                    const envScore = data.environmentScore || 0;
                    const esgRating = data.esgRating || 'Unknown';
                    const urbanLevel = data.urbanizationLevel || 'Unknown';
                    const pollutionIdx = data.pollutionIndex || 0;
                    const recommendations = data.recommendations || [];
                    const esgClass = ['A+', 'A', 'B+', 'B'].includes(esgRating) ? 'good' : ['C+', 'C'].includes(esgRating) ? 'moderate' : 'poor';

                    return `<div class="metric-display">
                        <div class="metric-value">${envScore.toFixed(0)}<span style="font-size: 1rem; font-weight: 500;">/100</span></div>
                        <div class="metric-label">Environment Score</div>
                        <div class="metric-secondary" style="margin-top: 0.5rem;">
                            üåø ESG: <span class="status-badge ${esgClass}">${esgRating}</span>
                            &nbsp;|&nbsp; üèôÔ∏è <strong>${urbanLevel}</strong>
                        </div>
                        ${pollutionIdx > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üí® Pollution index: <strong>${pollutionIdx.toFixed(1)}</strong>
                        </div>` : ''}
                        ${recommendations.length > 0 ? `<div class="metric-secondary" style="margin-top: 0.25rem;">
                            üí° <strong>${recommendations.length}</strong> recommendations available
                        </div>` : ''}
                    </div>`;

                // Default fallback - smart extraction for unknown APIs
                default:
                    return formatUnknownData(apiName, data);
            }
        }

        // Smart formatter for unknown data structures
        function formatUnknownData(apiName, data) {
            if (!data) return '';

            // If it's an array, show count and sample items
            if (Array.isArray(data)) {
                const count = data.length;
                const sampleItems = data.slice(0, 3).map(item => {
                    if (typeof item === 'string') return item;
                    if (typeof item === 'object') return item.name || item.naam || item.title || item.type || JSON.stringify(item).substring(0, 30);
                    return String(item);
                });

                return `<div class="metric-display">
                    <div class="metric-value">${count}</div>
                    <div class="metric-label">Items Found</div>
                    ${sampleItems.length > 0 ? `<div class="metric-secondary">${sampleItems.join(' ‚Ä¢ ')}</div>` : ''}
                </div>`;
            }

            // If it's an object, extract key metrics
            if (typeof data === 'object') {
                const keys = Object.keys(data);

                // Look for common numeric fields to highlight
                const numericFields = ['total', 'count', 'aantal', 'population', 'inhabitants', 'area', 'distance', 'value', 'score'];
                let primaryMetric = null;
                let primaryLabel = null;

                for (const field of numericFields) {
                    for (const key of keys) {
                        if (key.toLowerCase().includes(field) && typeof data[key] === 'number') {
                            primaryMetric = data[key];
                            primaryLabel = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase()).trim();
                            break;
                        }
                    }
                    if (primaryMetric !== null) break;
                }

                // Build secondary info from other fields
                const secondaryFields = [];
                for (const key of keys.slice(0, 5)) {
                    const val = data[key];
                    if (key === primaryLabel?.replace(/ /g, '')) continue;

                    if (typeof val === 'number') {
                        secondaryFields.push(`${key}: <strong>${val.toLocaleString()}</strong>`);
                    } else if (typeof val === 'string' && val.length < 30) {
                        secondaryFields.push(`${key}: <strong>${val}</strong>`);
                    } else if (Array.isArray(val)) {
                        secondaryFields.push(`${key}: <strong>${val.length} items</strong>`);
                    }
                }

                if (primaryMetric !== null) {
                    return `<div class="metric-display">
                        <div class="metric-value">${typeof primaryMetric === 'number' ? primaryMetric.toLocaleString() : primaryMetric}</div>
                        <div class="metric-label">${primaryLabel}</div>
                        ${secondaryFields.length > 0 ? `<div class="metric-secondary">${secondaryFields.slice(0, 3).join(' &nbsp;|&nbsp; ')}</div>` : ''}
                    </div>`;
                }

                // No numeric primary found, show first few fields
                if (secondaryFields.length > 0) {
                    return `<div class="metric-display">
                        <div class="metric-label" style="color: var(--success); margin-bottom: 0.5rem;">‚úì Data Retrieved</div>
                        <div class="metric-secondary">${secondaryFields.slice(0, 4).join('<br>')}</div>
                    </div>`;
                }
            }

            // Fallback for primitives or empty objects
            return `<div class="metric-display">
                <div class="metric-label" style="color: var(--success);">‚úì Data retrieved successfully</div>
            </div>`;
        }

        function renderApiResults() {
            const isMobile = window.innerWidth <= 768;
            const targetContainer = isMobile ? document.getElementById('results-mobile') : document.getElementById('results-desktop');

            if (!targetContainer) {
                return;
            }

            if (!currentResponse || !currentResponse.apiResults) {
                targetContainer.innerHTML = '';
                document.body.classList.remove('has-results');
                return;
            }

            const grouped = currentResponse.apiResults;
            const allResults = [...grouped.free, ...grouped.freemium, ...grouped.premium];
            const filtered = allResults.filter(result => enabledAPIs.has(result.name));

            const successCount = filtered.filter(r => r.status === 'success').length;
            const errorCount = filtered.filter(r => r.status === 'error').length;
            const notConfiguredCount = filtered.filter(r => r.status === 'not_configured').length;

            // Extract postcode and house number from address
            const address = currentResponse.address || 'Unknown Address';
            const coords = currentResponse.coordinates || [];
            const addressParts = address.match(/^(.+?)\s+(\d+[A-Za-z]?),\s*(\d{4}\s?[A-Z]{2})\s+(.+)$/);
            let street = address;
            let houseNum = '';
            let postcode = '';
            let city = '';
            if (addressParts) {
                street = addressParts[1];
                houseNum = addressParts[2];
                postcode = addressParts[3];
                city = addressParts[4];
            }

            // Address Header Card
            let html = `<div class="address-header-card">
                <div class="address-info">
                    <h2 class="address-title">${street}${houseNum ? ' ' + houseNum : ''}</h2>
                    <div class="address-meta">
                        ${postcode ? `<span class="address-tag">üìç <strong>${postcode}</strong></span>` : ''}
                        ${city ? `<span class="address-tag">üèôÔ∏è <strong>${city}</strong></span>` : ''}
                        <span class="address-tag">‚úì <strong>${successCount}</strong> APIs</span>
                        ${errorCount > 0 ? `<span class="address-tag" style="color: var(--danger);">‚úó <strong>${errorCount}</strong> errors</span>` : ''}
                    </div>
                </div>
                <div class="address-actions">
                    <button class="btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
                    <button class="btn btn-primary" onclick="exportCSV()">üì• Export CSV</button>
                </div>
            </div>`;

            // Helper function to render a section
            const renderSection = (title, icon, results) => {
                if (results.length === 0) return '';
                const sectionResults = results.filter(result => enabledAPIs.has(result.name));
                if (sectionResults.length === 0) return '';

                // Sort results: success first, then error, then not_configured
                const statusPriority = { 'success': 0, 'error': 1, 'not_configured': 2 };
                sectionResults.sort((a, b) => {
                    const priorityA = statusPriority[a.status] ?? 3;
                    const priorityB = statusPriority[b.status] ?? 3;
                    return priorityA - priorityB;
                });

                const sectionSuccess = sectionResults.filter(r => r.status === 'success').length;

                let sectionHtml = `<div class="tier-section">
                    <div class="section-header">
                        <span class="section-icon">${icon}</span>
                        <h4>${title}</h4>
                        <div class="summary-stats-inline">
                            <span class="summary-stat-inline success"><span class="count">${sectionSuccess}</span>/${sectionResults.length}</span>
                        </div>
                    </div>
                    <div class="api-results-grid">`;

                sectionResults.forEach(result => {
                    const statusClass = result.status === 'success' ? 'success' : result.status === 'error' ? 'error' : 'warning';
                    const errorMessage = result.error ? `<p class="metric-secondary" style="color: var(--danger);">${result.error}</p>` : '';
                    const formattedData = result.status === 'success' ? formatApiData(result.name, result.data) : '';
                    const dataBlock = result.data
                        ? `<details class="raw-data-toggle">
                                <summary>View Raw Data</summary>
                                <pre>${JSON.stringify(result.data, null, 2)}</pre>
                            </details>`
                        : '';

                    sectionHtml += `
                        <div class="result-card">
                            <div class="card-header-title">
                                <span class="status-dot ${statusClass}"></span>
                                ${result.name}
                            </div>
                            ${formattedData}
                            ${errorMessage}
                            ${dataBlock}
                        </div>
                    `;
                });

                sectionHtml += '</div></div>';
                return sectionHtml;
            };

            html += renderSection('Free', 'üåê', grouped.free);
            html += renderSection('Freemium', 'üîë', grouped.freemium);
            html += renderSection('Premium', 'üíé', grouped.premium);

            targetContainer.innerHTML = html;
            if (filtered.length > 0) {
                document.body.classList.add('has-results');
            } else {
                document.body.classList.remove('has-results');
            }
        }

        // Export data as CSV
        function exportCSV() {
            if (!currentResponse) {
                alert('No results to export');
                return;
            }

            const rows = [];
            rows.push(['Address', currentResponse.address]);
            rows.push(['Latitude', currentResponse.coordinates[1]]);
            rows.push(['Longitude', currentResponse.coordinates[0]]);
            rows.push([]);

            const grouped = currentResponse.apiResults;
            const allResults = [...grouped.free, ...grouped.freemium, ...grouped.premium];

            rows.push(['API Name', 'Category', 'Status', 'Data']);
            allResults
                .filter(r => enabledAPIs.has(r.name))
                .forEach(result => {
                    const dataStr = result.data ? JSON.stringify(result.data) : result.error || '';
                    rows.push([result.name, result.category, result.status, dataStr]);
                });

            const csvContent = rows.map(row =>
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `addressiq_${currentResponse.address.replace(/[^a-zA-Z0-9]/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Open settings modal
        function openSettings() {
            if (!currentResponse) {
                alert('Search for an address first');
                return;
            }

            const grouped = currentResponse.apiResults;
            const allAPIs = [...grouped.free, ...grouped.freemium, ...grouped.premium].map(r => r.name);

            let html = `
                <div class="modal is-active" id="settings-modal">
                    <div class="modal-background" onclick="closeSettings()"></div>
                    <div class="modal-card">
                        <header class="modal-card-head">
                            <p class="modal-card-title">API Settings</p>
                            <button class="delete" onclick="closeSettings()"></button>
                        </header>
                        <section class="modal-card-body">
                            <div class="buttons mb-3">
                                <button class="button is-success is-small" onclick="selectAllAPIs()">Select All</button>
                                <button class="button is-danger is-small" onclick="deselectAllAPIs()">Deselect All</button>
                            </div>
                            <div id="api-checkboxes">
            `;

            allAPIs.forEach(apiName => {
                const checked = enabledAPIs.has(apiName) ? 'checked' : '';
                html += `
                    <label class="checkbox is-block mb-2">
                        <input type="checkbox" value="${apiName}" ${checked} onchange="toggleAPI('${apiName}')">
                        ${apiName}
                    </label>
                `;
            });

            html += `
                            </div>
                        </section>
                        <footer class="modal-card-foot">
                            <button class="button is-success" onclick="saveSettings()">Save</button>
                            <button class="button" onclick="closeSettings()">Cancel</button>
                        </footer>
                    </div>
                </div>
            `;

            document.getElementById('modal-target').innerHTML = html;
        }

        function closeSettings() {
            document.getElementById('modal-target').innerHTML = '';
        }

        function toggleAPI(apiName) {
            if (enabledAPIs.has(apiName)) {
                enabledAPIs.delete(apiName);
            } else {
                enabledAPIs.add(apiName);
            }
            renderApiResults();
        }

        function selectAllAPIs() {
            if (!currentResponse) return;
            const grouped = currentResponse.apiResults;
            const allAPIs = [...grouped.free, ...grouped.freemium, ...grouped.premium];
            allAPIs.forEach(r => enabledAPIs.add(r.name));
            document.querySelectorAll('#api-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
            renderApiResults();
        }

        function deselectAllAPIs() {
            enabledAPIs.clear();
            document.querySelectorAll('#api-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
            renderApiResults();
        }

        function saveSettings() {
            localStorage.setItem('enabledAPIs', JSON.stringify([...enabledAPIs]));
            closeSettings();
            renderApiResults();
            alert('Settings saved! Enabled APIs: ' + enabledAPIs.size);
        }
    </script>
</body>
<div id="modal-target"></div>
</html>

